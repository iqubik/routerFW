#!/bin/bash
# ВАЖНО: ЭТОТ ФАЙЛ ДОЛЖЕН ИМЕТЬ КОДИРОВКУ КОНЦА СТРОК LF (UNIX)!
# VSCode: Снизу справа кликнуть "CRLF" -> выбрать "LF".
# Notepad++: Правка -> Формат конца строки -> UNIX (LF).

# ==============================================================================
#  OpenWrt SourceBuilder: Pre-Build Hook
#  File: hooks.sh
#  Description: Сценарий автоматической модификации исходного кода.
#               Запускается строго ПЕРЕД началом компиляции.
# ==============================================================================
#
#  КОНТЕКСТ ВЫПОЛНЕНИЯ:
#    - Где: Корневая директория исходников OpenWrt (/home/build/openwrt).
#    - Когда: После скачивания фидов и настройки .config, но ДО 'make'.
#    - Статус: Локальный скрипт сборщика (НЕ попадает внутрь прошивки).
#
#  ТИПОВЫЕ ЗАДАЧИ:
#    1. Применение патчей к ядру или пакетам (patch -p1 < ...).
#    2. Редактирование файлов через sed/awk (правка Makefile, DTS, конфигов).
#    3. Скачивание сторонних файлов/блобов (curl/wget).
#    4. Условная логика на основе переменных окружения ($SRC_TARGET, $PROFILE_NAME).
#
#  УПРАВЛЕНИЕ СБОРКОЙ:
#    exit 0 -> Успех, продолжить сборку.
#    exit 1 -> Критическая ошибка, немедленно остановить сборку.
# ==============================================================================

# 1. Определяем цвета для красивого вывода (опционально)
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[HOOK] >>> Запуск сценария hooks.sh...${NC}"

# 2. Определяем цель (файл, который будем менять)
# Ищем любой файл README (README, README.md и т.д.)
TARGET_FILE=$(find . -maxdepth 1 -name "README*" | head -n 1)

if [ -z "$TARGET_FILE" ]; then
    echo -e "${RED}[HOOK] Ошибка: Файл README не найден! Создаем новый.${NC}"
    TARGET_FILE="README.md"
    touch "$TARGET_FILE"
fi

echo -e "[HOOK] Целевой файл: ${TARGET_FILE}"

# 3. Подготавливаем данные для внесения
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")
SIGNATURE="Build processed by SourceBuilder on $TIMESTAMP"

# 4. Вносим изменения (добавляем строку в конец файла)
echo "Appending signature to $TARGET_FILE..."
echo "" >> "$TARGET_FILE"
echo "--- $SIGNATURE ---" >> "$TARGET_FILE"

# 5. ВАЛИДАЦИЯ (Проверка результата)
# Самая важная часть: проверяем, применились ли изменения
if grep -q "$SIGNATURE" "$TARGET_FILE"; then
    echo -e "${GREEN}[HOOK] УСПЕХ: Автограф успешно добавлен в $TARGET_FILE${NC}"
    echo "       Содержимое последней строки:"
    tail -n 1 "$TARGET_FILE"
else
    echo -e "${RED}[HOOK] ПРОВАЛ: Не удалось изменить файл $TARGET_FILE${NC}"
    # Возвращаем код ошибки, чтобы остановить сборку (если это критично)
    exit 1
fi

# 6. Пример условной логики (закомментирован)
# if [ "$SRC_TARGET" == "ramips" ]; then
#     echo "[HOOK] Обнаружена архитектура ramips, применяем спец. патчи..."
#     # sed -i ...
# fi

echo -e "${YELLOW}[HOOK] >>> Сценарий завершен корректно.${NC}"

# Всегда возвращаем 0 в конце, если всё прошло хорошо
exit 0