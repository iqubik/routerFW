---
description: Conventions for Windows Batch scripts in routerFW
globs: "**/*.bat"
alwaysApply: false
---

# Batch Script Conventions

## Style

- Header: `@echo off` then `rem file: <name>`
- `setlocal enabledelayedexpansion` for variable expansion in blocks
- Console: `chcp 65001 >nul` (UTF-8), `mode con: cols=120 lines=40`
- ANSI colors via ESC codes: `C_KEY`, `C_LBL`, `C_GRY`, `C_VAL`, `C_ERR`, `C_RST`

## Bilingual Pattern

Same weighted language detection as `.sh` but uses Windows-specific checks:
- Registry: `HKCU\Control Panel\Desktop\PreferredUILanguages`
- Install language: `HKLM\...\Nls\Language\InstallLanguage` (0419 = Russian)
- PowerShell: `Get-Culture`, `Get-WinUserLanguageList`
- Console codepage: CP866 = Russian

Dictionary is loaded from external `.env` files (`system/lang/{RU,EN}.bat.env`).
Format: `KEY=%C_VAL%value%C_RST%` (standard `.env`, no `set`).
Loader: `for /f "usebackq eol=# tokens=* delims=" %%a in ("%LANG_FILE%") do call set "%%a"` — `call set` gives double expansion for `%C_*%` color variables. Fallback to EN if file missing.

## Feature Parity

`.bat` scripts must stay in sync with their `.sh` counterparts:
- `_Builder.bat` <-> `_Builder.sh`
- `_packer.bat` <-> `_packer.sh`

When modifying one, the other must be updated with equivalent logic.

## FORBIDDEN

- NEVER read or edit `_unpacker.bat` — contains base64 payload
