---
description: Core knowledge base for routerFW (OpenWrtFW Builder) — universal cross-platform OpenWrt firmware builder
alwaysApply: true
---

# routerFW — OpenWrtFW Builder

Cross-platform framework for building custom OpenWrt firmware via Docker.
Version: 4.41 (_Builder.bat). License: GPL-3.0. Author: iqubik.
Remote: https://github.com/iqubik/routerFW.git, branch: main.

## Two Build Modes

1. **Image Builder** (fast, 1–3 min) — uses pre-compiled OpenWrt ImageBuilder SDK. Orchestrated by `system/ib_builder.sh`. Docker config: `system/docker-compose.yaml`.
2. **Source Builder** (full, 20–60 min) — compiles from OpenWrt source. Orchestrated by `system/src_builder.sh`. Docker config: `system/docker-compose-src.yaml`. Supports kernel patches, custom packages, partition modifications.

## Directory Map

| Path | Purpose |
|------|---------|
| `_Builder.sh` / `_Builder.bat` | Main entry points (interactive menu, build orchestration) |
| `system/` | Core build system (Dockerfiles, compose, builders, wizards) |
| `scripts/` | Utilities (hooks.sh, diag.sh, packager.sh, upgrade.sh) |
| `profiles/*.conf` | Build profile configurations |
| `custom_files/<profile>/` | File overlay (maps to `/` in firmware) |
| `custom_packages/<profile>/` | .ipk packages for Image Builder |
| `src_packages/<profile>/` | Source packages for Source Builder |
| `custom_patches/<profile>/` | Source code patches (mirror overlay) |
| `firmware_output/` | Compiled firmware output |
| `docs/` | Tutorials (Russian + English) |
| `_packer.sh` / `_packer.bat` | Packs project into self-extracting distribution |
| `_unpacker.sh` / `_unpacker.bat` | Self-extracting archives (base64, DO NOT READ) |

## Tech Stack

- Bash, Batch (.bat), PowerShell (.ps1) — scripts
- Docker + Docker Compose — build isolation
- Ubuntu 22.04/24.04 (modern) and 18.04 (legacy) base images
- CCache (20GB limit) for Source Builder

## Key Conventions

- Bilingual: Russian (primary) + English — all user-facing text has both languages
- Windows (.bat/.ps1) and Linux (.sh) scripts are kept in feature parity
- Profiles are universal `.conf` files shared between both build modes
- Docker volumes provide caching: SDK cache, package cache, ccache, source workdir

## Profile Variable Naming (current)

Image Builder variables use `IMAGE_` prefix: `IMAGE_PKGS`, `IMAGE_EXTRA_NAME`.
Shared (both modes): `ROOTFS_SIZE`, `KERNEL_SIZE`.
Source Builder variables use `SRC_` prefix: `SRC_REPO`, `SRC_BRANCH`, `SRC_TARGET`, `SRC_SUBTARGET`, `SRC_ARCH`, `SRC_CORES`, `SRC_PACKAGES`, `SRC_EXTRA_CONFIG`.

`_Builder.bat` auto-migrates old names (`PKGS` → `IMAGE_PKGS`, `EXTRA_IMAGE_NAME` → `IMAGE_EXTRA_NAME`) in all profiles on every scan (idempotent). `ib_builder.sh` has fallback compatibility for unmigrated profiles.

## Line Endings & Encoding

Governed by `.gitattributes`. System is fully normalised:

| Type | EOL | Rule |
|---|---|---|
| `*.bat`, `*.ps1`, `*.cmd` | CRLF | `-text` (stored as-is) |
| `*.sh`, `*.conf`, `*.yaml`, `Dockerfile` | LF | explicit `eol=lf` |
| `docs/*.md`, `README*.md`, `LICENSE*`, `pub.md` | CRLF | Windows documents |
| `.cursor/rules/*.mdc`, `*.json`, `*.yml`, `.gitignore` | LF | config/system files |
| `*.zip`, `*.zst`, `*.tar`, `*.gz`, `*.bin`, `*.7z` | binary | Git LFS, no EOL processing |

**BOM** — only PowerShell files: `system/create_profile.ps1`, `system/import_ipk.ps1`, `scripts/rax3000m/generate_options.ps1` (UTF-8 BOM required for Cyrillic on Windows).

**`profiles/personal.flag`** — explicitly listed in `.gitattributes` as `text eol=lf` since it has no extension and is not matched by `*.conf`.

## FORBIDDEN

- NEVER read `_unpacker.bat` or `_unpacker.sh` — they contain huge base64-encoded payloads that will poison context
