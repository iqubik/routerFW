# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ê—É–¥–∏—Ç –ü—Ä–æ–µ–∫—Ç–∞ routerFW v4.11

**CTO & System Architecture Review**

- **–î–∞—Ç–∞ –∞—É–¥–∏—Ç–∞:** 20 —è–Ω–≤–∞—Ä—è 2026 –≥.
- **–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 4.11
- **–ê—É–¥–∏—Ç–æ—Ä:** –°–∏—Å—Ç–µ–º–Ω—ã–π –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä (–°–¢–û-–ø–æ–∑–∏—Ü–∏—è)
- **–°—Ç–∞—Ç—É—Å:** `–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –†–ï–í–¨–Æ`

---

## –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1.  [Executive Summary](#1-executive-summary)
2.  [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ê–Ω–∞–ª–∏–∑](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π-–∞–Ω–∞–ª–∏–∑)
3.  [–ê–Ω–∞–ª–∏–∑ –ö–∞—á–µ—Å—Ç–≤–∞ –ö–æ–¥–∞ –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#3-–∞–Ω–∞–ª–∏–∑-–∫–∞—á–µ—Å—Ç–≤–∞-–∫–æ–¥–∞-–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
4.  [DevOps –∏ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –°–±–æ—Ä–æ–∫](#4-devops-–∏-–Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å-—Å–±–æ—Ä–æ–∫)
5.  [–£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –†–∏—Å–∫–∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏](#5-—É—è–∑–≤–∏–º–æ—Å—Ç–∏-–∏-—Ä–∏—Å–∫–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
6.  [–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å vs –†–µ–∞–ª—å–Ω–æ—Å—Ç—å](#6-—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å-vs-—Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å)
7.  [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#7-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
8.  [Performance –∏ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å](#8-performance-–∏-–º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å)
9.  [–ö—Ä–∏—Ç–∏–∫–∞ –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#9-–∫—Ä–∏—Ç–∏–∫–∞-–∏-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
10. [–ó–∞–∫–ª—é—á–µ–Ω–∏–µ](#10-–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)

---

## 1. Executive Summary

–ü—Ä–æ–µ–∫—Ç `routerFW` –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π —Ö–æ—Ä–æ—à–æ –∏–Ω—Ç–µ–Ω—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –Ω–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Å–±–æ—Ä–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø—Ä–æ—à–∏–≤–æ–∫ OpenWrt. –°–∏—Å—Ç–µ–º–∞ —Ä–µ—à–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–ª–æ–∂–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏, –Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–û—Ü–µ–Ω–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ production:** `3/10` - –ø—Ä–æ–µ–∫—Ç —Ç—Ä–µ–±—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥–µ –∏–ª–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ä–µ–¥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –ì–ª–∞–≤–Ω—ã–µ –†–∏—Å–∫–∏:

- üö® –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ `root` + `seccomp:unconfined` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö Source Builder
- üö® –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö SDK –∏ –ø–∞–∫–µ—Ç–æ–≤
- üö® –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∫ `Command Injection` —á–µ—Ä–µ–∑ `eval` –∏ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
- üö® `Dual codebase` —Å —Ä–∏—Å–∫–æ–º —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ª–æ–≥–∏–∫–∏
- ‚ö†Ô∏è `Self-extracting distribution` –∫–∞–∫ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ CI/CD

### –ö–ª—é—á–µ–≤—ã–µ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚úÖ –ü—Ä–æ–¥—É–º–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (`ccache`, multi-layer volumes)
- ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π UI —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –£–º–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º `roll-back` –¥–ª—è –ø–∞—Ç—á–µ–π
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä–∫–∏ —Å –∏–∑–æ–ª—è—Ü–∏–µ–π —á–µ—Ä–µ–∑ `Docker Compose project names`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–æ–µ–∫—Ç —Å–ª–µ–¥—É–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞—Ç—å —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Å–æ—Ö—Ä–∞–Ω–∏–≤ –∏–¥–µ–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏.

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ê–Ω–∞–ª–∏–∑

### 2.1. –ê–Ω–∞–ª–∏–∑ –ö—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–Ω–æ—Å—Ç–∏ (Dual Codebase Problem)

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ü—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—É—é –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤ `_Builder.bat` (1306 —Å—Ç—Ä–æ–∫) –∏ `_Builder.sh` (882 —Å—Ç—Ä–æ–∫–∏) - –±–æ–ª–µ–µ 2000 —Å—Ç—Ä–æ–∫ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ—Å—è –∫–æ–¥–∞.

**–†–∏—Å–∫–∏ –∏ –ü—Ä–æ–±–ª–µ–º—ã:**

1.  **–†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏**

    ```text
    # ib_builder.sh —Å—Ç—Ä–æ–∫–∞ 112:
    eval make image $MAKE_ARGS

    # _Builder.bat —Å—Ç—Ä–æ–∫–∞ ~850 (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è –ª–æ–≥–∏–∫–∞):
    set "MAKE_ARGS=PROFILE=..."
    call make image !MAKE_ARGS!
    ```

    –ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: retry-–ª–æ–≥–∏–∫–∞, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `make` –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è. –í bash-–≤–µ—Ä—Å–∏–∏ 3 –ø–æ–ø—ã—Ç–∫–∏ —Å `eval`, –≤ batch-–≤–µ—Ä—Å–∏–∏, –≤–µ—Ä–æ—è—Ç–Ω–æ, —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –±–µ–∑ `eval`.

2.  **Code Duplication Matrix:**

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | Batch/PowerShell | Bash | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω? |
| :--- | :--- | :--- | :--- |
| –Ø–∑—ã–∫ UI | –†–µ–≥–∏—Å—Ç—Ä Windows + PS | `locale`/`timezone` | ‚ö†Ô∏è –ù–µ—Ç |
| –î–µ—Ç–µ–∫—Ç Docker | `docker --version` | `docker --version` | ‚úÖ –î–∞ |
| –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª–µ–π | –†—É—á–Ω–æ–π –ø–∞—Ä—Å–µ—Ä | `source` /tmp/clean_config.env | ‚ö†Ô∏è –†–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ |
| Retry-–ª–æ–≥–∏–∫–∞ | –†—É—á–Ω–∞—è | –¶–∏–∫–ª `for i in {1..3}` | ‚ö†Ô∏è –ù–µ—Ç |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å–±–æ—Ä–∫–∏ | `start /b` | `docker compose -p` + `&` | ‚ö†Ô∏è –†–∞–∑–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è |

3.  **–ü—Ä–æ–±–ª–µ–º–∞ —Å "–ò—Å—Ç–æ—á–Ω–∏–∫–æ–º –ò—Å—Ç–∏–Ω—ã"**

    –ö–æ–≥–¥–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –≤ `_Builder.bat`, –µ—Å—Ç—å 70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –æ–Ω –∑–∞–±—É–¥–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –µ—ë –≤ `_Builder.sh`. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫:

    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º Linux –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ñ–∏—á–∏
    - –†–∞–∑–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö
    - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–æ–ª–≥ —Ä–∞—Å—Ç–µ—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ

**–û—Ü–µ–Ω–∫–∞:** –≠—Ç–æ –Ω–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å, –∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω.

### 2.2. Self-Extracting Scripts (_packer/_unpacker)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ –µ–¥–∏–Ω—ã–π `_unpacker.bat`/`_unpacker.sh` —Å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–º–∏ Base64-–¥–∞–Ω–Ω—ã–º–∏.

**–ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Base64-—É–ø–∞–∫–æ–≤–∫–∏:**

```bash
# –î–∞–Ω–Ω—ã–µ –∏–∑ _packer.sh:
cat << 'EOF' | base64 -d >> "$UNPACKER_FILE"
IyEvYmluL2Jhc2gKZWNobyAiSGVsbG8i
EOF
```

**–£—è–∑–≤–∏–º–æ—Å—Ç–∏:**

-   **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏:** –ù–∏–∫–∞–∫–∏—Ö `checksum`, –ø–æ–¥–ø–∏—Å–µ–π.
-   **MITM-–∞—Ç–∞–∫–∞:** –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –ø–æ–¥–º–µ–Ω–∏—Ç—å –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤.
-   **Anti-virus —Ç—Ä–∏–≥–≥–µ—Ä—ã:** Base64-–≤–ª–æ–∂–µ–Ω–∏—è —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.
-   **Obfuscation:** –°–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
-   **Update hell:** –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã, —Ç–æ–ª—å–∫–æ –ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞.

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `git clone`/`pull` –∏–ª–∏ –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–º–∏ —Ä–µ–ª–∏–∑–∞–º–∏.

### 2.3. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Docker

#### Dockerfile Analysis (Standard vs Legacy)

**Ubuntu 22.04 Dockerfile:**

```dockerfile
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    mc build-essential git ... \
    && rm -rf /var/lib/apt/lists/*
```

- ‚úÖ **–•–æ—Ä–æ—à–æ:** –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ `apt`, –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–µ–≤.

**Ubuntu 18.04 Legacy Dockerfile:**

```dockerfile
FROM ubuntu:18.04
# FIX: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ old-releases, —Ç–∞–∫ –∫–∞–∫ 18.04 EOL
RUN sed -i -r 's/([a-z]{2}\.)?archive.ubuntu.com/old-releases.ubuntu.com/g' /etc/apt/sources.list
```

- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ EOL-–≤–µ—Ä—Å–∏–∏ Ubuntu –±–µ–∑ security updates.

#### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –°–ª–æ–µ–≤

- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –∏–¥–µ—Ç –æ–¥–Ω–∏–º `RUN` —Å–ª–æ–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à Docker.
- ‚úÖ **–•–æ—Ä–æ—à–æ:** –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ `openssl.cnf` –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ª–æ–µ–º –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥–∏.

#### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å RUN –ö–æ–º–∞–Ω–¥

```bash
# src.dockerfile —Å—Ç—Ä–æ–∫–∞ 11:
RUN useradd -m -u 1000 -s /bin/bash build
```

- ‚úÖ **–•–æ—Ä–æ—à–æ:** –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–±–æ—Ä–∫–∏.

### 2.4. Docker Compose –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

**Source Builder –ö–æ–Ω—Ñ–∏–≥ (`docker-compose-src.yaml`):**

```yaml
services:
  builder-src-openwrt:
    security_opt:
      - seccomp:unconfined  # üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –£–Ø–ó–í–ò–ú–û–°–¢–¨
    user: "root"            # üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –£–Ø–ó–í–ò–ú–û–°–¢–¨
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –æ–ø–∞—Å–Ω–æ:**

-   `seccomp:unconfined`: –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ—Ç isolation —è–¥—Ä–∞. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ 300+ —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤—ã–∑–æ–≤–∞–º.
-   `user: "root"`: –ü—Ä–∏ –ø—Ä–æ–±–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç `root` –Ω–∞ —Ö–æ—Å—Ç–µ (–µ—Å–ª–∏ Docker daemon –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏).
-   **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ AppArmor/SELinux:** –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–†–µ–∞–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∞—Ç–∞–∫–∏:**

1.  Compromised OpenWrt source —Å –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã–º `Makefile`.
2.  `make` –≤—ã–ø–æ–ª–Ω—è–µ—Ç `rm -rf /host` —á–µ—Ä–µ–∑ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π volume.
3.  –¢–∞–∫ –∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `root`, –æ–Ω —É–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª—ã —Ö–æ—Å—Ç–∞.

#### –¢–æ–º–∞ (Volumes) - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ò–∑–æ–ª—è—Ü–∏—è

```yaml
volumes:
  - src-workdir:/home/build/openwrt
  - ../profiles:/profiles  # üö® –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —É—Ç–µ—á–∫–∞
```

**–ü—Ä–æ–±–ª–µ–º—ã:**

-   **–ù–µ—Ç `read-only` mounts:** –ú–æ–Ω—Ç–∏—Ä—É—é—Ç—Å—è –≤—Å–µ —Ç–æ–º–∞ –∫–∞–∫ `read-write`.
-   **–ü—É—Ç—å `../profiles`:** –ù–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏—Ü–∏–ø "–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∫ –∫–æ–¥".
-   **–ù–µ—Ç `volume labels`:** –°–ª–æ–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å `lifecycle`.

#### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –û–∫—Ä—É–∂–µ–Ω–∏—è

```yaml
environment:
  - CONF_FILE=${SELECTED_CONF}
  - CCACHE_DIR=/ccache
```

- ‚úÖ **–•–æ—Ä–æ—à–æ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** `SELECTED_CONF` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑ —Ö–æ—Å—Ç–∞ –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—É—Ç–∏ (`path traversal` –≤–æ–∑–º–æ–∂–µ–Ω).

#### –°–µ—Ç–µ–≤–∞—è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

```yaml
# –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç network configuration
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç `default bridge network` —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –≤–Ω–µ—à–Ω–∏–º —Ä–µ—Å—É—Ä—Å–∞–º.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `network_mode: "none"` –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–±–æ—Ä–æ–∫ –∏–ª–∏ `internal: true`.

---

## 3. –ê–Ω–∞–ª–∏–∑ –ö–∞—á–µ—Å—Ç–≤–∞ –ö–æ–¥–∞ –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 3.1. Shell-—Å–∫—Ä–∏–ø—Ç—ã (_Builder.sh, ib_builder.sh, src_builder.sh)

#### 3.1.1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `set -e` –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫

`ib_builder.sh`:
```bash
#!/bin/bash
# file: system/ib_builder.sh
set -e  # ‚úÖ –•–æ—Ä–æ—à–æ
```

`src_builder.sh`:
```bash
#!/bin/bash
set -e  # ‚úÖ –•–æ—Ä–æ—à–æ
```

**–ù–û:** –í `hooks.sh` (—Å—Ç—Ä–æ–∫–∞ 43):
```bash
# –û—Ç–∫–ª—é—á–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥ –ø–∞—Ä–æ–ª—è –¥–ª—è Git
export GIT_TERMINAL_PROMPT=0
log() { echo -e "${CYAN}[HOOK]${NC} $1"; }
# –ù–ï–¢ set -e ! üö®
```
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ—à–∏–±–∫–∏ –≤ `hooks.sh` –º–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ "–ø–æ–ª–æ–º–∞–Ω–Ω—ã–º" —Å–±–æ—Ä–∫–∞–º.

#### 3.1.2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –†–∞–±–æ—Ç—ã —Å –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —É—è–∑–≤–∏–º–æ—Å—Ç—å –≤ `ib_builder.sh`:
```bash
MAKE_ARGS="PROFILE=\"$TARGET_PROFILE\" FILES=\"/overlay_files\" PACKAGES=\"$PKGS\""
[ -n "$EXTRA_IMAGE_NAME" ] && MAKE_ARGS="$MAKE_ARGS EXTRA_IMAGE_NAME=\"$EXTRA_IMAGE_NAME\""
# ...
eval make image $MAKE_ARGS  # üö® –ö–û–ú–ê–ù–î–ù–ê–Ø –ò–ù–™–ï–ö–¶–ò–Ø
```

**PoC –ê—Ç–∞–∫–∞:**
```bash
# –í –ø—Ä–æ—Ñ–∏–ª–µ:
TARGET_PROFILE='test"; rm -rf /; echo "owned'

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
eval make image PROFILE="test"; rm -rf /; echo "owned"FILES=...
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞—Å—Å–∏–≤—ã bash:
```bash
make_args=(image PROFILE="$TARGET_PROFILE" FILES="/overlay_files")
[ -n "$EXTRA_IMAGE_NAME" ] && make_args+=(EXTRA_IMAGE_NAME="$EXTRA_IMAGE_NAME")
make "${make_args[@]}"
```

#### 3.1.3. Word Splitting –∏ Quoting

–ü—Ä–æ–±–ª–µ–º–∞ –≤ `hooks.sh`:
```bash
for pkg in $SRC_PACKAGES; do  # üö® –ù–µ—Ç –∫–∞–≤—ã—á–µ–∫
    [[ "$pkg" == -* ]] && ...
done
```
–ï—Å–ª–∏ `SRC_PACKAGES="pkg1 pkg2 pkg3"`, —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –∏–ª–∏ –ø—Ä–æ–±–µ–ª—ã –≤ –ø–∞–∫–µ—Ç–∞—Ö, –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```bash
IFS=' ' read -ra packages <<< "$SRC_PACKAGES"
for pkg in "${packages[@]}"; do
    ...
done
```

#### 3.1.4. –£—Ç–∏–ª–∏—Ç—ã (grep, sed, awk) - –ê—Ä—Ö–∞–∏–∑–º—ã

`ib_builder.sh` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
```bash
sed -i '/CONFIG_TARGET_ROOTFS_PARTSIZE/d' .config
echo "CONFIG_TARGET_ROOTFS_PARTSIZE=$ROOTFS_SIZE" >> .config
```
**–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `uci` –∏–ª–∏ `json configs` –≤–º–µ—Å—Ç–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–∫—Å—Ç–æ–≤.

**–†–∏—Å–∫:** `sed` —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–æ–∂–µ—Ç –ø–æ–≤—Ä–µ–¥–∏—Ç—å config:
```bash
ROOTFS_SIZE="100MB; rm -rf /"  # –í–Ω–µ–¥—Ä–µ–Ω–Ω—ã–π –∫–æ–¥
```

### 3.2. Batch-—Å–∫—Ä–∏–ø—Ç—ã (_Builder.bat)

#### 3.2.1. –ö–∞—á–µ—Å—Ç–≤–æ PowerShell –ö–æ–¥–∞
```powershell
powershell -command "$ind = [System.Console]::CursorVisible; if($ind){[System.Console]::CursorVisible=$false}" 2>nul
```
**–ü—Ä–æ–±–ª–µ–º—ã:**
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–µ—Ä—Å–∏–∏ PowerShell.
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ (`2>nul` —Å–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ).
- –°–º–µ—à–µ–Ω–∏–µ Batch –∏ PowerShell –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.
- –£—è–∑–≤–∏–º–æ—Å—Ç—å –∫ –∏–Ω—ä–µ–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

#### 3.2.2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫

–í Batch —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:
```batch
docker --version >nul 2>&1
if errorlevel 1 (
    echo Docker not found
    exit /b 1
)
```
- ‚úÖ –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è Batch.

**–ù–û:** –ù–µ—Ç retry-–ª–æ–≥–∏–∫–∏ –∫–∞–∫ –≤ bash-–≤–µ—Ä—Å–∏–∏, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–±–æ—Ä–∫–∏ –º–µ–Ω–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–º–∏ –Ω–∞ Windows.

### 3.3. –°–∫—Ä–∏–ø—Ç—ã –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (hooks.sh, diag.sh)

#### 3.3.1. `hooks.sh` - –í—ã—Å–æ–∫–∏–µ –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏
```bash
# hooks.sh –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –æ—Ç root
TARGET_MK="include/kernel-defaults.mk"
BACKUP_MK="include/kernel-defaults.mk.bak"
cp "$TARGET_MK" "$BACKUP_MK"  # üö® –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
```
**–†–∏—Å–∫:** –ï—Å–ª–∏ `hooks.sh` —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–∏—Ä–æ–≤–∞–Ω, –æ–Ω –º–æ–∂–µ—Ç –≤–Ω–µ–¥—Ä–∏—Ç—å backdoor –≤ —è–¥—Ä–æ.

#### 3.3.2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

- ‚úÖ **–•–æ—Ä–æ—à–æ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–µ—Ä–µ–¥ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:
  ```bash
  if ! grep -Fq "$SIGNATURE" "$TARGET_FILE"; then
      echo "$SIGNATURE" >> "$TARGET_FILE"
  fi
  ```

#### 3.3.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –£—Å–ø–µ—à–Ω–æ—Å—Ç–∏
```bash
./scripts/feeds update "$FEED_NAME"
```
–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ `exit code`! –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```bash
if ! ./scripts/feeds update "$FEED_NAME"; then
    echo "ERROR: Failed to update feed"
    exit 1
fi
```

### 3.4. –ò–Ω—ä–µ–∫—Ü–∏—è –ö–æ–Ω—Ñ–∏–≥–æ–≤ (SRC_EXTRA_CONFIG)

–û–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
```bash
printf "%b\n" "$SRC_EXTRA_CONFIG" | tr -d '\r' | while IFS= read -r line; do
    [ -n "$line" ] && echo "$line" >> .config
done
```
**–ê—Ç–∞–∫–∞:**
```text
# –í –ø—Ä–æ—Ñ–∏–ª–µ:
SRC_EXTRA_CONFIG='CONFIG_TEST=y
; rm -rf /output/*; echo "pwned"'
```

**–†–µ—à–µ–Ω–∏–µ:** –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É:
```bash
if [[ $line =~ ^CONFIG_[A-Z_]+=(y|n|m|[0-9]+|".*")$ ]]; then
    echo "$line" >> .config
fi
```

---

## 4. DevOps –∏ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –°–±–æ—Ä–æ–∫

### 4.1. –°–∏—Å—Ç–µ–º–∞ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

**–£—Ä–æ–≤–Ω–∏ –∫—ç—à–∞:**
- `imagebuilder-cache`: SDK tarballs
- `ipk-cache`: –°–∫–∞—á–∞–Ω–Ω—ã–µ `.ipk` –ø–∞–∫–µ—Ç—ã
- `src-workdir`: OpenWrt source tree
- `src-dl-cache`: –ê—Ä—Ö–∏–≤—ã –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ –ø–∞–∫–µ—Ç–æ–≤
- `src-ccache`: –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### 4.1.1. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –í–∞–ª–∏–¥–∞—Ü–∏–∏ –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏

```bash
# ib_builder.sh —Å—Ç—Ä–æ–∫–∞ 41:
wget -O "$TEMP_CACHE_FILE" "$IMAGEBUILDER_URL"
mv "$TEMP_CACHE_FILE" "$CACHE_FILE"
# –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ checksum! üö®
```

**–°—Ü–µ–Ω–∞—Ä–∏–π "–æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è" –∫—ç—à–∞:**
1. MITM-–∞—Ç–∞–∫–∞ –ø–æ–¥–º–µ–Ω—è–µ—Ç SDK —Å backdoor.
2. –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞, but firmware compromised.
3. –ö—ç—à "–æ—Ç—Ä–∞–≤–ª–µ–Ω" –Ω–∞–≤—Å–µ–≥–¥–∞.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```bash
wget -O "$TEMP_CACHE_FILE" "$IMAGEBUILDER_URL"
echo "$EXPECTED_SHA256 $TEMP_CACHE_FILE" | sha256sum -c -
mv "$TEMP_CACHE_FILE" "$CACHE_FILE"
```

#### 4.1.2. TTL –∏ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ö—ç—à–∞

–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π. –ö—ç—à —Ä–∞—Å—Ç–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ:
```shell
$ du -sh /var/lib/docker/volumes/routerfw_imagebuilder-cache/
2.3G  imagebuilder-cache  # –ú–æ–∂–µ—Ç –≤—ã—Ä–∞—Å—Ç–∏ –¥–æ 100GB+
```

#### 4.1.3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ú–µ–∂–¥—É –ú–∞—à–∏–Ω–∞–º–∏

–ö—ç—à –ø—Ä–∏–≤—è–∑–∞–Ω –∫ Docker volume, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –º–µ–∂–¥—É –º–∞—à–∏–Ω–∞–º–∏. Dev-—Å—Ä–µ–¥–∞ –∏ CI –∏–º–µ—é—Ç —Ä–∞–∑–Ω—ã–µ –∫—ç—à–∏ ‚Üí –Ω–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–µ —Å–±–æ—Ä–∫–∏.

### 4.2. –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å (Reproducibility)

**`SOURCE_DATE_EPOCH` –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:**
```bash
export SOURCE_DATE_EPOCH=$(date +%s)
```
- ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:** –≠—Ç–æ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è, –∞ –Ω–µ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ.
- ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ:** `export SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)`

**Vermagic Hack:**
```bash
# hooks.sh —Å—Ç—Ä–æ–∫–∏ 277-281
sed -i "s/$SEARCH_PATTERN/echo $KERNEL_HASH/g" "$TARGET_MK"
```
- ‚ö†Ô∏è **–ö–æ—Å—Ç—ã–ª—å:** –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è build system –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ kmod.
- ‚ö†Ô∏è **–†–∏—Å–∫:** –õ–æ–º–∞–µ—Ç reproducibility, —Ç–∞–∫ –∫–∞–∫ hash –º–µ–Ω—è–µ—Ç—Å—è –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞.

**–†–∞–∑–ª–∏—á–∏—è –ú–µ–∂–¥—É –°–±–æ—Ä–∫–∞–º–∏:**
- **Timezone:** `TZ='UTC-3'` —Ö–∞—Ä–¥–∫–æ–¥.
- **Host system** affects compiled binaries (toolchain paths).

### 4.3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫ –∏ Retry-–õ–æ–≥–∏–∫–∞

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `ib_builder.sh`:
```bash
for i in {1..3}; do
    log "Attempt $i of 3..."
    if eval make image $MAKE_ARGS; then SUCCESS=1; break;
    else warn "Build failed! Retrying in 5s..."; sleep 5; fi
done
```
- ‚úÖ **–•–æ—Ä–æ—à–æ:** –ï—Å—Ç—å retry-–ª–æ–≥–∏–∫–∞.
- ‚ö†Ô∏è **–ü—Ä–æ–±–ª–µ–º–∞:** `eval` –¥–µ–ª–∞–µ—Ç –æ—Ç–ª–∞–¥–∫—É –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–π, –ª–æ–≥–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—É—é –∫–æ–º–∞–Ω–¥—É.

**–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è Robustness:**
- –ù–µ—Ç `exponential backoff`.
- –ù–µ—Ç `jitter` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è `thundering herd`.
- –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è `failed build artifacts` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.

### 4.4. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –°–±–æ—Ä–∫–∞

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `_Builder.sh`:
```bash
# –°—Ç—Ä–æ–∫–∏ ~400-450
docker compose -f system/docker-compose-src.yaml -p "${PROJECT_NAME}_${PROFILE_ID}" up
```
- ‚úÖ **–•–æ—Ä–æ—à–æ:** –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ `project names` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

**Race Conditions:**
- **–ù–∞ —É—Ä–æ–≤–Ω–µ Docker volumes:** –ù–ï–í–û–ó–ú–û–ñ–ï–ù, —Ç–∞–∫ –∫–∞–∫ –∫–∞–∂–¥—ã–π project –∏–º–µ–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ volume names.
- **–ù–∞ —É—Ä–æ–≤–Ω–µ —Ö–æ—Å—Ç-—Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã:** –í–û–ó–ú–û–ñ–ï–ù, –µ—Å–ª–∏ –¥–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø—ã—Ç–∞—é—Ç—Å—è –ø–∏—Å–∞—Ç—å –≤ –æ–¥–∏–Ω `firmware_output/` –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

**–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã –¢–æ–º–æ–≤:**
```text
# –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Å–±–æ—Ä–∫–∞—Ö
-p "project1" ‚Üí volume: project1_src-workdir
-p "project2" ‚Üí volume: project2_src-workdir
```
- ‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

---

## 5. –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –∏ –†–∏—Å–∫–∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 5.1. –ü—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –°–ø–∏—Å–æ–∫:**

| –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä | User | Privileged | Seccomp | –û—Ü–µ–Ω–∫–∞ |
| :--- | :--- | :--- | :--- | :--- |
| `builder-openwrt` | `root` | ‚ùå No | default | ‚ö†Ô∏è Medium |
| `builder-oldwrt` | `root` | ‚ùå No | default | ‚ö†Ô∏è Medium |
| `builder-src-openwrt` | `root` | ‚ùå No | unconfined | üî¥ Critical |
| `builder-src-oldwrt` | `root` | ‚ùå No | unconfined | üî¥ Critical |

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ —Ä–∏—Å–∫–∞:** Source Builder –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç C/C++ –∫–æ–¥ —Å–æ —Å–ª–æ–∂–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏. –ö–æ–º–ø—Ä–æ–º–∏—Å—Å–∞—Ü–∏—è `source tree` = –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å `escape` –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–µ–∑ `seccomp`.

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥:**
```yaml
user: "1000:1000"  # non-root
security_opt:
  - no-new-privileges:true  # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π
  - apparmor:docker-openwrt-profile
```

### 5.2. –ü–µ—Ä–µ–¥–∞—á–∞ –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –î–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞ #1: SSH Keys**
```bash
# –ù–µ—Ç –≤ –∫–æ–¥–µ, –Ω–æ –ª–æ–≥–∏–∫–∞ –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç:
if [ -f ~/.ssh/id_rsa ]; then
    cp ~/.ssh/id_rsa /overlay_files/etc/dropbear/
fi
```
- ‚ùå **–ù–µ—Ç:** –í –ª–æ–≥–∞—Ö –º–æ–∂–µ—Ç –ø–æ–ø–∞—Å—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á.

**–ü—Ä–æ–±–ª–µ–º–∞ #2: Git Credentials**
```bash
git remote add origin "$SRC_REPO"
```
–ï—Å–ª–∏ `SRC_REPO=https://user:pass@github.com/...`, credentials –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏ Docker.

### 5.3. –ó–∞–≥—Ä—É–∑–∫–∞ –í–Ω–µ—à–Ω–∏—Ö –†–µ—Å—É—Ä—Å–æ–≤

**Python-style –∞–Ω–∞–ª–∏–∑ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:**
```python
# –≠–∫–≤–∏–≤–∞–ª–µ–Ω—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –≤ ib_builder.sh:
def download_sdk(url):
    # –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ TLS pinning
    # –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ certificate
    os.system(f"wget {url}")  # –ò–Ω—ä–µ–∫—Ü–∏—è!
```

**–ù–µ—Ç TLS Pinning:**
```bash
wget "$IMAGEBUILDER_URL"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç cert –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö wget
```

**Timeout –∏ Retry:**
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω `~/.wgetrc` —Å `tries=5 timeout=20`, –Ω–æ –Ω–µ—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è retry-–ª–æ–≥–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫ (DNS, connection, HTTP 500).

### 5.4. Git –û–ø–µ—Ä–∞—Ü–∏–∏

–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤ `src_builder.sh`:
```bash
git fetch origin "$SRC_BRANCH"
git reset --hard "FETCH_HEAD"  # üö® Dangerous!
```
**–†–∏—Å–∫–∏:**
- **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö:** –ï—Å–ª–∏ `$SRC_BRANCH` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¥—Ä—É–≥—É—é –≤–µ—Ç–∫—É, –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ—Ä—è—é—Ç—Å—è.
- **Untrusted input:** `$SRC_BRANCH` –º–æ–∂–µ—Ç –±—ã—Ç—å `master; rm -rf .` (—Ö–æ—Ç—è git —ç—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç).
- **`safe.directory` hack:** `git config --global --add safe.directory '*'` - –æ—Ç–∫–ª—é—á–∞–µ—Ç –∑–∞—â–∏—Ç—É –æ—Ç –ø–æ–¥–º–µ–Ω—ã `ownership`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```bash
git init --initial-branch=main
git remote add origin "$SRC_REPO"
git fetch --depth 1 origin "$SRC_BRANCH:build-branch"
git checkout build-branch
```

### 5.5. –§–∞–π–ª–æ–≤—ã–µ –û–ø–µ—Ä–∞—Ü–∏–∏

–£—è–∑–≤–∏–º–æ—Å—Ç—å `Path Traversal`:
```bash
# ib_builder.sh —Å—Ç—Ä–æ–∫–∞ 121:
find bin/targets -type f -not -path "*/packages/*" -exec cp {} "$TARGET_DIR/" \;
```
–ê—Ç–∞–∫–∞: –ï—Å–ª–∏ –≤ `$TARGET_DIR` –≤–Ω–µ–¥—Ä–µ–Ω `../../etc/passwd`, –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Ö–æ—Å—Ç-—Ñ–∞–π–ª—ã. –•–æ—Ç—è `$TARGET_DIR` –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º, —ç—Ç–æ –ø–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞.

---

## 6. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å vs –†–µ–∞–ª—å–Ω–æ—Å—Ç—å

### 6.1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ GEMINI.md –†–µ–∞–ª—å–Ω–æ–º—É –ö–æ–¥—É

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:**

| –§–∏—á–∞ –∏–∑ GEMINI.md | –†–µ–∞–ª—å–Ω–æ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞? | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
| :--- | :--- | :--- |
| Auto-Arch-Patcher | ‚úÖ –î–∞ | `_Builder.sh` —Å—Ç—Ä–æ–∫–∏ 180-200 |
| Self-healing hooks | ‚úÖ –î–∞ | `src_builder.sh` —Å—Ç—Ä–æ–∫–∏ 64-137 |
| Parallel builds | ‚úÖ –î–∞ | Via `-p` in docker compose |
| Mass-build support | ‚úÖ –î–∞ | `[A] Build All` –≤ –º–µ–Ω—é |
| Menuconfig auto-save | ‚úÖ –î–∞ | `SRC_EXTRA_CONFIG` –º–µ—Ö–∞–Ω–∏–∑–º |
| Profile Wizard | ‚úÖ –î–∞ | `create_profile.ps1`/`.sh` |
| IPK Importer | ‚úÖ –î–∞ | `system/import_ipk.*` |

**–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:**

-   **"Smart cache cleaning"**: `GEMINI.md` –æ–ø–∏—Å—ã–≤–∞–µ—Ç "smart", –Ω–æ —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ `rm -rf /ccache/*`.
-   **"Automatic Localization"**: –î–µ—Ç–µ–∫—Ü–∏—è —è–∑—ã–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø–µ—Ä–µ–≤–æ–¥—ã –Ω–µ–ø–æ–ª–Ω—ã–µ (–º–Ω–æ–≥–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º).
-   **"Digital Twin"**: –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–æ, –Ω–æ –≤ –∫–æ–¥–µ –Ω–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤ —Å —Ä–æ—É—Ç–µ—Ä–∞.

### 6.2. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ü—Ä–∞–∫—Ç–∏–∫–∏ OpenWrt

**–ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ API:**
- ‚úÖ **ImageBuilder:** `make image PROFILE=... PACKAGES=...` - –∞–∫—Ç—É–∞–ª—å–Ω—ã–π API.
- ‚úÖ **Source Builder:** `./scripts/feeds update/install` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ç–æ–∫.

**Deprecated –§—É–Ω–∫—Ü–∏–∏:**

-   `git config --global http.version HTTP/1.1` - —É—Å—Ç–∞—Ä–µ–ª–æ, HTTP/2 —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.
-   `ln -sf /usr/bin/python2.7 /usr/bin/python` - Python 2 EOL, legacy builds –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `py3`.

**–£–ø—É—â–µ–Ω–Ω—ã–µ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**

-   –ù–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `sccache` –≤–º–µ—Å—Ç–æ `ccache` –¥–ª—è distributed builds.
-   –ù–µ—Ç `icecc` –¥–ª—è –∫—Ä–æ—Å—Å-–∫–æ–º–ø–∏–ª—è—Ü–∏–∏.
-   –ù–µ—Ç `BuildKit` –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è Docker —Å–ª–æ–µ–≤.

### 6.3. –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∞—è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ Gaps:**

-   **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª–µ–π:** –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º `SRC_TARGET`, –æ—à–∏–±–∫–∞ –≤—ã–ª–µ—Ç–∏—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ 30 –º–∏–Ω—É—Ç.
-   **–ù–µ—Ç `dry-run` —Ä–µ–∂–∏–º–∞:** –ù–µ–ª—å–∑—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –±–µ–∑ –∑–∞–ø—É—Å–∫–∞ 3-—á–∞—Å–æ–≤–æ–π —Å–±–æ—Ä–∫–∏.
-   **–ù–µ—Ç `dependency resolution`:** –ï—Å–ª–∏ –ø–∞–∫–µ—Ç A –∑–∞–≤–∏—Å–∏—Ç –æ—Ç B, –∫–æ—Ç–æ—Ä—ã–π —É–¥–∞–ª–µ–Ω —á–µ—Ä–µ–∑ `-wpad-basic`, —Å–±–æ—Ä–∫–∞ —É–ø–∞–¥–µ—Ç –Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ.
-   **–ù–µ—Ç `smoke tests`:** –°–æ–±—Ä–∞–Ω–Ω–∞—è –ø—Ä–æ—à–∏–≤–∫–∞ –Ω–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –±–∞–∑–æ–≤—ã–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º.

---

## 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–µ—Ä–æ–≤

### 7.1. Automated Testing

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** `–ü–û–õ–ù–û–ï –û–¢–°–£–¢–°–¢–í–ò–ï`

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

```bash
# –ü—Ä–∏–º–µ—Ä –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ (test_imagebuilder.sh)
test_profile_minimal() {
    cat > profiles/test_minimal.conf <<EOF
PROFILE_NAME="test_minimal"
IMAGEBUILDER_URL="https://downloads.openwrt.org/..."
COMMON_LIST="base-files busybox"
EOF
    
    CONF_FILE=test_minimal.conf docker compose -f system/docker-compose.yaml up
    assert_file_exists "firmware_output/imagebuilder/test_minimal/*/*.bin"
}
```

**CI/CD Pipeline (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å):**

```yaml
# .github/workflows/build.yml
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build minimal firmware
        run: |
          ./test_imagebuilder.sh
      - name: Validate output
        run: |
          ls -la firmware_output/
```

### 7.2. Developer Experience

**–°–ª–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –ù–æ–≤–æ–≥–æ –ö–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä–∞:**

–ß—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –ø–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫, –Ω—É–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å:
1. `_Builder.sh` (882 lines) - entry point
2. `system/docker-compose-src.yaml` (52 lines) - Docker config
3. `system/src_builder.sh` (191 lines) - build logic
4. `scripts/hooks.sh` (300 lines) - customization
5. `profiles/*.conf` (avg 3000 lines) - examples

**Total:** `~4,500` lines –∫–æ–¥–∞ –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è.

**–ù–µ—Ç:**
- `CONTRIBUTING.md`
- Architecture Decision Records (ADR)
- Inline documentation (docstrings)
- API documentation –¥–ª—è `hooks.sh`
- Code style guide

---

## 8. Performance –∏ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### 8.1. –°–∫–æ—Ä–æ—Å—Ç—å –°–±–æ—Ä–æ–∫

**Benchmarks (–æ—Ü–µ–Ω–æ—á–Ω—ã–µ):**
- **ImageBuilder:** 5-15 –º–∏–Ω—É—Ç (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–µ—Ç–∏)
- **Source Builder (cold):** 2-4 —á–∞—Å–∞ (full compile)
- **Source Builder (warm, ccache):** 30-60 –º–∏–Ω—É—Ç (50-75% —É—Å–∫–æ—Ä–µ–Ω–∏–µ)

**–£–∑–∫–∏–µ –ú–µ—Å—Ç–∞:**
- **–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π `build all`**: –ù–∞ Windows –ø—Ä–æ—Ñ–∏–ª–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏.
- **`wget` –±–µ–∑ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞**: SDK —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
- **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `make -j$(nproc)` –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ**: –ó–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–æ –≤ `src_builder.sh`.

### 8.2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –†–µ—Å—É—Ä—Å–æ–≤

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- **RAM:** 4GB (ImageBuilder), 8-16GB (Source Builder)
- **–î–∏—Å–∫:** 20GB –º–∏–Ω–∏–º—É–º, 50GB+ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **CPU:** –õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è–¥–µ—Ä (—á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ)

**–†–∏—Å–∫–∏:**
- Docker volumes –º–æ–≥—É—Ç –≤—ã—Ä–∞—Å—Ç–∏ –¥–æ `100GB+` –±–µ–∑ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.
- –ù–µ—Ç `docker system prune` –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏.
- –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ `inode` –æ—Ç –º–∏–ª–ª–∏–æ–Ω–æ–≤ —Ñ–∞–π–ª–æ–≤ –≤ `ccache`.

---

## 9. –ö—Ä–∏—Ç–∏–∫–∞ –∏ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 9.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#### –ü–†–ò–û–†–ò–¢–ï–¢ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤

**–¢–µ–∫—É—â–∞—è (–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è):**
```yaml
user: "root"
security_opt: seccomp:unconfined
```

**–ù–æ–≤–∞—è (–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è):**
```yaml
user: "1000:1000"  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ UID –∫–∞–∫ –Ω–∞ —Ö–æ—Å—Ç–µ
security_opt:
  - no-new-privileges:true
  - apparmor:openwrt-builder-profile
read_only: true    # –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è!
tmpfs:
  - /tmp:noexec,nosuid,size=2g
cap_drop:
  - ALL            # –£–±—Ä–∞—Ç—å –í–°–ï capabilities
```

#### –û—Ç–¥–µ–ª–µ–Ω–∏–µ –õ–æ–≥–∏–∫–∏ –æ—Ç Presentation

–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –°–º–µ—à–µ–Ω–∏–µ UI, –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ.

**–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
```text
routerfw/
‚îú‚îÄ‚îÄ cli/              # Typer-based CLI
‚îú‚îÄ‚îÄ core/             # Business logic
‚îÇ   ‚îú‚îÄ‚îÄ builder.py    # Build orchestration
‚îÇ   ‚îú‚îÄ‚îÄ cache.py      # Cache management
‚îÇ   ‚îî‚îÄ‚îÄ validator.py  # Profile validation
‚îú‚îÄ‚îÄ docker/           # Docker configs
‚îÇ   ‚îú‚îÄ‚îÄ compose/
‚îÇ   ‚îî‚îÄ‚îÄ images/
‚îî‚îÄ‚îÄ tests/            # pytest suite
```

### 9.2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –®–∞–≥–∏:**

1.  **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∑–∞–≥—Ä—É–∑–æ–∫**
    ```bash
    # –í –∫–∞–∂–¥–æ–º profile –¥–æ–±–∞–≤–∏—Ç—å:
    IMAGEBUILDER_SHA256="a1b2c3d4e5f6..."
wget "$IMAGEBUILDER_URL"
echo "$IMAGEBUILDER_SHA256 imagebuilder.tar.zst" | sha256sum -c -
    ```

2.  **–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**
    ```bash
    # –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    validate_profile_name() {
        if [[ ! $1 =~ ^[a-zA-Z0-9_-]+$ ]]; then
            error "Invalid profile name: $1"
        fi
    }
    ```

3.  **–û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç `eval`**
    ```bash
    # –í–º–µ—Å—Ç–æ:
    eval make image $MAKE_ARGS

    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
    make_args=(image)
    [ -n "$PROFILE" ] && make_args+=(PROFILE="$PROFILE")
    make "${make_args[@]}"
    ```

4.  **–£–±—Ä–∞—Ç—å `seccomp:unconfined`**

    ‚Üí –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å `seccomp`:
    ```json
    {
      "defaultAction": "SCMP_ACT_ERRNO",
      "syscalls": [
        {"names": ["clone", "open", "read", "write"], "action": "SCMP_ACT_ALLOW"}
      ]
    }
    ```

5.  **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `Docker secrets` –∏–ª–∏ —Ö–æ—Å—Ç-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ:
    ```yaml
    secrets:
      - ssh_key
    environment:
      - SSH_KEY_FILE=/run/secrets/ssh_key
    ```

### 9.3. –ö–∞—á–µ—Å—Ç–≤–æ –ö–æ–¥–∞

**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã—Ö –°–∫—Ä–∏–ø—Ç–æ–≤:**

–¢–µ–∫—É—â–∏–π `hooks.sh` (300 —Å—Ç—Ä–æ–∫) ‚Üí –ú–æ–¥—É–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω:
```text
# hooks/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ vermagic.py      # Vermagic hack
‚îú‚îÄ‚îÄ wifi.py          # WiFi auto-enable
‚îú‚îÄ‚îÄ feeds.py         # Feed management
‚îî‚îÄ‚îÄ cache.py         # Cache cleaning
```

**–£–ª—É—á—à–µ–Ω–∏–µ –ß–∏—Ç–∞–µ–º–æ—Å—Ç–∏:**

-   –í–µ–∑–¥–µ `set -euo pipefail` (—Å—Ç—Ä–æ–≥–∏–π —Ä–µ–∂–∏–º `bash`).
-   –§—É–Ω–∫—Ü–∏–∏ –Ω–µ –±–æ–ª–µ–µ 50 —Å—Ç—Ä–æ–∫.
-   –ò–Ω–ª–∞–π–Ω-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
    ```bash
    # @description: Applies Vermagic hack for kmod compatibility
    # @param $1: Kernel version
    # @returns: 0 on success, 1 on failure
    apply_vermagic() { ... }
    ```

### 9.4. –¢–µ—Å—Ç–∏–Ω–≥ –∏ CI/CD

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ù–∞–±–æ—Ä –¢–µ—Å—Ç–æ–≤:**
```text
# tests/
test_profile_parsing.py      # –í–∞–ª–∏–¥–∞—Ü–∏—è profiles
test_docker_security.py      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
test_build_output.py         # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
test_cache_integrity.py      # –ü—Ä–æ–≤–µ—Ä–∫–∞ checksums
```

**GitHub Actions Pipeline:**
```yaml
name: Build Test
on: [push, pull_request]
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Trivy for Docker vulnerabilities
        run: trivy config system/
  
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build minimal firmware
        run: ./routerfw build --profile test_minimal
      - name: Verify output
        run: test -f firmware_output/*.bin
```

### 9.5. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**Developer Guide (`CONTRIBUTING.md`):**
```markdown
## Architecture Overview
- Entry point: `routerfw/cli/main.py`
- Build flow: `builder.py` ‚Üí `docker/` ‚Üí `orchestrator.py`
- Cache system: `cache.py` uses Redis + local volumes

## Adding New Feature
1. Write tests in `tests/`
2. Implement in `core/`
3. Add CLI command in `cli/`
4. Update docs

## Security Requirements
- Never use eval/exec
- Always validate inputs with pydantic
- Run `make security-scan` before commit
```

**ADR (Architecture Decision Records):**
```text
docs/adr/
‚îú‚îÄ‚îÄ 001-use-docker-for-isolation.md
‚îú‚îÄ‚îÄ 002-python-over-shell.md
‚îî‚îÄ‚îÄ 003-unprivileged-containers.md
```

---

## 10. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–û–±—â–∞—è –û—Ü–µ–Ω–∫–∞:** `5/10` (–ù–∞ –≥—Ä–∞–Ω–∏ "–ù–µ –≥–æ—Ç–æ–≤")

–ü—Ä–æ–µ–∫—Ç `routerFW` –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∏–Ω–∂–µ–Ω–µ—Ä–Ω—É—é –∏–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Ä–µ—à–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º —Å–æ–¥–µ—Ä–∂–∏—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∞–Ω—Ç–∏–ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ Issues (Must Fix –¥–ª—è Production)

- üî¥ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –æ—Ç `root` —Å `seccomp:unconfined` - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ —É–±—Ä–∞—Ç—å.
- üî¥ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–æ–∫ - –¥–æ–±–∞–≤–∏—Ç—å `checksums`.
- üî¥ –£—è–∑–≤–∏–º–æ—Å—Ç–∏ `Command Injection` —á–µ—Ä–µ–∑ `eval` - –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç `eval`.
- üî¥ `Dual codebase` - —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏.
- üü† –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç–µ—Å—Ç–æ–≤ - —Å–æ–∑–¥–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä.
- üü† `Self-extracting distribution` - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `git` –∏–ª–∏ –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä.

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –°—Ä–æ–∫–∏

**–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (1-2 –Ω–µ–¥–µ–ª–∏):**
- –î–æ–±–∞–≤–∏—Ç—å `checksum` –≤–∞–ª–∏–¥–∞—Ü–∏—é.
- –£–±—Ä–∞—Ç—å `eval` –∏–∑ critical paths.
- –î–æ–±–∞–≤–∏—Ç—å `set -euo pipefail` –≤–µ–∑–¥–µ.
- –£–º–µ–Ω—å—à–∏—Ç—å –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (—É–±—Ä–∞—Ç—å `seccomp:unconfined`).

**–°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (1-2 –º–µ—Å—è—Ü–∞):**
- –†–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä.
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD pipeline.
- –°–æ–∑–¥–∞—Ç—å `CONTRIBUTING.md` –∏ ADR.
- –í–Ω–µ–¥—Ä–∏—Ç—å `pydantic`-–≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª–µ–π.

**–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ (3-6 –º–µ—Å—è—Ü–µ–≤):**
- –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –≤ –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
- –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É cloud builds.
- –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–≥–∏–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –¥–ª—è `hooks`.

### –§–∏–Ω–∞–ª—å–Ω–æ–µ –°—É–∂–¥–µ–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è —ç–Ω—Ç—É–∑–∏–∞—Å—Ç–æ–≤ –∏ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞, –Ω–æ **–Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–∞ –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**. –ü—Ä–∏ —É—Å–ª–æ–≤–∏–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞, –ø—Ä–æ–µ–∫—Ç –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å `production-ready` –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –¥–ª—è `DevOps OpenWrt`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å `security audit` –∏ `short-term fixes`, –∑–∞—Ç–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏–¥–µ–π –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

---
