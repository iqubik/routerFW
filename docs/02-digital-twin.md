# Урок 2: Цементированный backup ваших настроек

**Цель:** Собрать свежую прошивку, в которую будут "вцементированы" все программы и настройки с вашего текущего роутера.

Это самый практичный и полезный сценарий использования Билдера. Мы сделаем это в два этапа: сначала тестовая сборка, чтобы убедиться, что всё работает, а затем — финальная, с вашими данными.

---

### Шаг 0: Создаем архив с настройками

1.  Зайдите в веб-интерфейс вашего роутера (обычно `192.168.1.1`).
2.  Перейдите в меню **System -> Backup / Flash Firmware**.
3.  Нажмите на кнопку **Generate archive** и сохраните файл (например, `backup-OpenWrt-2026-01-07.tar.gz`) на ваш компьютер.

### Шаг 1: Создаем базовый профиль с помощью Мастера

Теперь нам нужен "чистый" рецепт для сборки под вашу модель роутера. Мы получим его с помощью Мастера Профилей (`create_profile.ps1`), а всю необходимую информацию возьмём из имени файла официальной прошивки.

**1. Анализируем имя файла прошивки**

Найдите на [официальном сайте OpenWrt](https://firmware-selector.openwrt.org/) или на странице релизов вашего форка (ImmortalWrt и т.д.) прошивку для обновления (`sysupgrade`). Её имя — это ключ ко всему.

Рассмотрим на вашем примере: `immortalwrt-mediatek-filogic-cmcc_rax3000m-nand-mtk-squashfs-sysupgrade.bin`

-   `immortalwrt`: Это **Релиз** или дистрибутив (может быть `openwrt-23.05.2`).
-   `mediatek-filogic`: Это **Цель** (Target) и **Под-цель** (Subtarget). Мастер может попросить вас выбрать сначала `mediatek`, а потом `filogic`.
-   `cmcc_rax3000m-nand-mtk`: Это **Профиль** (Profile) — конкретная модель вашего устройства.

**2. Запускаем Мастер и вводим данные**

Теперь, когда у нас есть эта информация:

1.  В главном меню Билдера выберите опцию **[W] Profile Wizard**.
2.  Мастер последовательно спросит вас о тех параметрах, которые мы только что определили: **Release, Target, Profile**. Вводите их, ориентируясь на разобранное имя файла.
3.  На вопрос о добавлении пакетов пока **ничего не вставляйте**, просто нажмите Enter.

В результате в папке `profiles/` появится файл `asus_rt_n56u_b1_25120-rc1_ow_full.conf` с уже правильными техническими параметрами.

### Шаг 2: Тестовая сборка

Это важная проверка, чтобы убедиться, что базовый профиль создан верно и система работает.

1.  Запустите `_Builder.bat` снова. В меню появится ваш новый профиль. Введите его номер и нажмите Enter.
2.  Дождитесь завершения сборки. Если она прошла успешно и файлы прошивки появились, значит, всё в порядке.
Можно удалять эту тестовую прошивку из папки `firmware_output/imagebuilder/` и двигаться дальше.

### Шаг 3: Добавляем ваши данные

Теперь "оживляем" наш чистый профиль.

1.  **Настройки:** Перейдите в папку `custom_files/`. Найдите там новую папку с **точным названием вашего профиля**. Распакуйте в неё архив `backup.tar.gz` из Шага 2.
Это первый ключ персонализации.
2.  **Программы:** Откройте файл `profiles/**.conf`. Найдите строку `COMMON_LIST=""` и вставьте между кавычек список пакетов, который вы получим ниже.

### Получаем список программ (пакетов)

Чтобы в новой прошивке были все установленные вами программы (AdGuard, VPN-клиенты и т.д.), их список нужно скопировать.

1.  Подключитесь к вашему роутеру по SSH.
2.  Выполните и скопируйте результат этой команды. Она автоматически сгенерирует чистый список пакетов, которые вы установили дополнительно:
    ```bash
    wget -qO- https://raw.githubusercontent.com/iqubik/routerFW/main/scripts/show_pkgs.sh | sh
    ```
    >Пример вывода команды:
    ```
    root@OpenWrt2:~# wget -qO- https://raw.githubusercontent.com/iqubik/routerFW/main/scripts/show_pkgs.sh | sh
    -----------------------v0.1 (Hardcoded Filter)-------------------
    arp-scan arp-scan-database bash batctl-full bind-host block-mount bzip2 ca-certificates collectd-mod-ping coreutils-ls curl dnsmasq drill ethtool-full fastfetch gawk grep gzip htop iftop ip-full iw-full knot-host libustream-openssl20201210 luci-app-argon-config luci-app-attendedsysupgrade luci-app-commands luci-app-cpu-status luci-app-iperf3 luci-app-statistics luci-app-ttyd luci-compat luci-i18n-attendedsysupgrade-ru luci-i18n-base-ru luci-i18n-commands-ru luci-i18n-cpu-status-ru luci-i18n-firewall-ru luci-i18n-package-manager-ru luci-i18n-statistics-ru luci-i18n-ttyd-ru luci-i18n-usteer-ru luci-proto-batman-adv luci-proto-vxlan luci-theme-argon mc nano openssh-client-utils openssh-sftp-server opkg ppp-mod-pppoe procd-ujail screen sed tar tcpdump unzip urandom-seed urngd wpad-openssl
    -----------------------------------------------------------------

    -----------------------v0.2 (Smart ROM Diff)---------------------
    ethtool-full
    -----------------------end---------------------------------------    

    ```
    Тут используется 2 типа фильтров:
    ** первый вывод ** - это список пакетов которые не были автоматически установлены в системе, то есть не являются зависимостями других пакетов.
    ** второй вывод ** - используется сравнение со списком пакетов системы "из коробки" с целью найти отличия с текущим состоянием системы.
    К сожалению формирование такого списка пока не удаётся польностью автоматизировать, но это точка будущего роста.

3.  Сохраните этот список в переменную `COMMON_LIST=""` внутри профиля. Это второй из двух ключей к конфигурации вашей персональной сборки.
4.  Это пожалуй самый тонкий момент со списком нужных пакетов. Тут с полученным списком имеет смысл сходить к ИИ с целью фильтрации и улучшения результата.

### Шаг 4: Финальная "цементирующая" сборка

1.  Снова запустите `_Builder.bat`.
2.  Выберите тот же профиль для сборки.
3.  Дождитесь завершения.

**Готово!** Теперь в папке `firmware_output` лежит прошивка, в которую "вцементированы" все ваши пакеты и настройки. После установки этой прошивки роутер сразу будет работать так, как вы привыкли.