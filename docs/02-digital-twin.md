# Урок 2: Цементированный backup ваших настроек

**Цель:** Собрать свежую прошивку, в которую будут "вцементированы" все программы и настройки с вашего текущего роутера.

Это самый практичный и полезный сценарий использования Билдера. Мы сделаем это в два этапа: сначала тестовая сборка, чтобы убедиться, что всё работает, а затем — финальная, с вашими данными.

---

### Шаг 0: Создаем архив с настройками

1.  Зайдите в веб-интерфейс вашего роутера (обычно `192.168.1.1`).
2.  Перейдите в меню **System -> Backup / Flash Firmware**.
3.  Нажмите на кнопку **Generate archive** и сохраните файл (например, `backup-OpenWrt-2026-01-07.tar.gz`) на ваш компьютер.

### Шаг 1: Создаем базовый профиль с помощью Мастера

Теперь нам нужен "чистый" рецепт для сборки под вашу модель роутера. Мы получим его с помощью Мастера Профилей (`create_profile.ps1`), а всю необходимую информацию возьмём из имени файла официальной прошивки.

**1. Анализируем имя файла прошивки**

Найдите на [официальном сайте OpenWrt](https://firmware-selector.openwrt.org/) или на странице релизов вашего форка (ImmortalWrt и т.д.) прошивку для обновления (`sysupgrade`). Её имя — это ключ ко всему.

Рассмотрим на вашем примере: `immortalwrt-mediatek-filogic-cmcc_rax3000m-nand-mtk-squashfs-sysupgrade.bin`

-   `immortalwrt`: Это **Релиз** или дистрибутив (может быть `openwrt-23.05.2`).
-   `mediatek-filogic`: Это **Цель** (Target) и **Под-цель** (Subtarget). Мастер может попросить вас выбрать сначала `mediatek`, а потом `filogic`.
-   `cmcc_rax3000m-nand-mtk`: Это **Профиль** (Profile) — конкретная модель вашего устройства.

**2. Запускаем Мастер и вводим данные**

Теперь, когда у нас есть эта информация:

1.  В главном меню Билдера выберите опцию **[W] Profile Wizard**.
2.  Мастер последовательно спросит вас о тех параметрах, которые мы только что определили: **Release, Target, Profile**. Вводите их, ориентируясь на разобранное имя файла.
3.  На вопрос о добавлении пакетов пока **ничего не вставляйте**, просто нажмите Enter.

В результате в папке `profiles/` появится файл `asus_rt_n56u_b1_25120-rc1_ow_full.conf` с уже правильными техническими параметрами.

### Шаг 2: Тестовая сборка

Это важная проверка, чтобы убедиться, что базовый профиль создан верно и система работает.

1.  Запустите `_Builder.bat` снова. В меню появится ваш новый профиль. Введите его номер и нажмите Enter.
2.  Дождитесь завершения сборки. Если она прошла успешно и файлы прошивки появились, значит, всё в порядке.
Можно удалять эту тестовую прошивку из папки `firmware_output/imagebuilder/` и двигаться дальше.

### ⚙️ Анатомия Универсального Профиля

Прежде чем вносить изменения, давайте заглянем «под капот». Билдер использует единый файл для обоих режимов сборки. Если вы создали профиль через Мастер, откройте его в `profiles/ваш_профиль.conf`. Вы увидите структуру, разделенную на логические блоки:

```bash
PROFILE_NAME="my_router"
TARGET_PROFILE="xiaomi_mi-router-4a-gigabit"

# Общий список пакетов для обоих режимов
COMMON_LIST="luci uhttpd htop -wpad-basic wpad-mbedtls"

# БЛОК IMAGE BUILDER (Быстрая сборка из готовых пакетов)
IMAGEBUILDER_URL="https://downloads.openwrt.org/..."
PKGS="$COMMON_LIST" # Можно добавить или исключить пакеты через '-'

# БЛОК SOURCE BUILDER (Полная компиляция из исходников)
SRC_REPO="https://github.com/openwrt/openwrt.git"
SRC_BRANCH="v24.10.0"
SRC_TARGET="ramips"
SRC_SUBTARGET="mt7621"
SRC_PACKAGES="$COMMON_LIST"

# Настройки ресурсов и железа (Source Builder)
SRC_CORES="safe"       # Использовать все ядра CPU кроме одного (N-1)
SRC_EXTRA_CONFIG="CONFIG_TARGET_KERNEL_PARTSIZE=64 \
CONFIG_TARGET_ROOTFS_PARTSIZE=256"
```

**Почему это удобно?** Вам не нужно вести два разных списка программ. Вы просто редактируете `COMMON_LIST`, и изменения подхватываются как при быстрой сборке (Image), так и при глубокой компиляции (Source).

---

### Куда именно вставить:
Вставьте этот блок сразу после завершения **Шага 2** (перед заголовком `### Шаг 3: Добавляем ваши данные`). 

### Почему это важно для этого урока:
1. **Разделение сущностей:** Пользователь сразу видит разницу между настройками для «быстрой» и «полной» сборки.
2. **Переменная `COMMON_LIST`:** В Шаге 3 вы просите пользователя найти эту строку. Благодаря этому вставленному блоку он уже знает, что это за переменная и за что она отвечает.
3. **SRC_CORES и Лимиты:** Это готовит пользователя к тому, что Source-сборка требует настройки ресурсов железа (о чем упоминается в структуре).

### Шаг 3: Добавляем ваши данные

Теперь "оживляем" наш чистый профиль.

1.  **Настройки:** Перейдите в папку `custom_files/`. Найдите там новую папку с **точным названием вашего профиля**. Распакуйте в неё архив `backup.tar.gz` из Шага 2.
Это первый ключ персонализации.
2.  **Программы:** Откройте файл `profiles/**.conf`. Найдите строку `COMMON_LIST=""` и вставьте между кавычек список пакетов, который вы получим ниже.

### Получаем список программ (пакетов)

Чтобы в новой прошивке были все установленные вами программы (AdGuard, VPN-клиенты и т.д.), их список нужно скопировать.

1.  Подключитесь к вашему роутеру по SSH.
2.  Выполните и скопируйте результат этой команды. Она автоматически сгенерирует чистый список пакетов, которые вы установили дополнительно:
    ```bash
    wget -qO- https://raw.githubusercontent.com/iqubik/routerFW/main/scripts/show_pkgs.sh | sh
    ```
    >Пример вывода команды:
    ```
    root@OpenWrt2:~# wget -qO- https://raw.githubusercontent.com/iqubik/routerFW/main/scripts/show_pkgs.sh | sh
    -----------------------v0.1 (Hardcoded Filter)-------------------
    arp-scan arp-scan-database
    -----------------------------------------------------------------

    -----------------------v0.2 (Smart ROM Diff)---------------------
    ethtool-full
    -----------------------end---------------------------------------    

    ```
    Тут используется 2 типа фильтров:

    ** первый вывод ** - это список пакетов, которые не были автоматически установлены в системе, то есть не являются зависимостями других пакетов.

    ** второй вывод ** - используется сравнение со списком пакетов системы "из коробки" с целью найти отличия с текущим состоянием системы.
    
    К сожалению формирование такого списка пока не удаётся польностью автоматизировать, но это точка будущего роста.

3.  Сохраните этот список в переменную `COMMON_LIST=""` внутри профиля. Это второй из двух ключей к конфигурации вашей персональной сборки.
4.  Это пожалуй самый тонкий момент со списком нужных пакетов. Тут с полученным списком имеет смысл сходить к ИИ с целью фильтрации и улучшения результата.

### Шаг 4: Финальная "цементирующая" сборка

1.  Снова запустите `_Builder.bat`.
2.  Выберите тот же профиль для сборки.
3.  Дождитесь завершения.

**Готово!** Теперь в папке `firmware_output` лежит прошивка, в которую "вцементированы" все ваши пакеты и настройки. После установки этой прошивки роутер сразу будет работать так, как вы привыкли.