# Урок 3: Сборка из исходников: Максимальный контроль

**Цель:** Освоить продвинутый метод сборки из исходников (`Source Builder`), используя в качестве основы рекомендуемый конфиг от разработчика.

Этот урок покажет профессиональный подход к сборке, который необходим для сложных случаев, например, при использовании форков OpenWrt (ImmortalWrt) или когда требуется особая конфигурация ядра.

---

### Когда это нужно?

Вы уже знаете, что `Source Builder` нужен для глубоких изменений. Этот продвинутый метод понадобится, если:
*   Вы собираете прошивку из нестандартного репозитория (форка).
*   Простая сборка "в лоб" выдает ошибки зависимостей.
*   Вы хотите быть уверены, что ваша сборка включает все рекомендации и оптимизации от автора исходного кода.

### Практический пример: Сборка для Rax3000m из кастомного репозитория

Мы разберем реальный кейс, описанный в `debug.md`: сборка прошивки для `rax3000m` из репозитория `padavanonly`.

#### Шаг 1: Создание и настройка профиля

1.  **Создаем основу через Мастер.** Чтобы не писать конфиг с нуля, поступим хитрее. Как и в Уроке 2, запустите `_Builder.bat`, выберите **[W] Profile Wizard** и создайте базовый профиль для вашего устройства. Назовите его, например, `rax3000m_source_build`.
    *Это даст нам готовый файл `profiles/rax3000m_source_build.conf` с уже заполненными базовыми параметрами.*

2.  **Настраиваем для сборки из исходников.** Откройте созданный файл. Теперь наша задача — отредактировать в нем секцию `Sourcebuilder`, указав правильный репозиторий и ветку для нашей цели:

```conf
# Целевое устройство у нас уже указано
TARGET_PROFILE="cmcc_rax3000m-emmc"

# --- Секция для Sourcebuilder ---
# Указываем кастомный репозиторий и ветку
SRC_REPO="https://github.com/padavanonly/immortalwrt-mt798x-6.6.git"

# Цель и профиль, как в Уроке 2
# Можно узнать из строки браузера и вконце дописать .git
SRC_REPO="https://github.com/padavanonly/immortalwrt-mt798x-6.6.git"
# Точное значение ветки(branch) или тега(tag) так же узнаётся на странице исходников на гите.
SRC_BRANCH="openwrt-24.10-6.6"
SRC_TARGET="mediatek"
SRC_SUBTARGET="filogic"

# Эту переменную пока оставляем пустой
SRC_EXTRA_CONFIG=""
```

#### Шаг 2: Поиск и подготовка базового конфига

Авторы форков часто предоставляют базовые "defconfig" файлы — это скелет конфигурации.

1.  Находим такой файл в репозитории. Для нашего примера он лежит по адресу `defconfig/mt7981-ax3000.config` в репозитории.
Почему был взят именно этот файл - по названию процессора со страницы https://openwrt.org/toh/cmcc/rax3000m а там указан MediaTek MT7981B - 7981!
2.  Скачиваем его содержимое и сохраняем на свой ПК, например, пока под именем `rax3000m_base.config`.

#### Шаг 3: Инициализация и "подмена" конфига

Это ключевой этап.

1.  В меню Билдера **переключитесь в режим `SOURCE BUILDER`** (клавиша `M`).
2.  Выберите опцию **[C] Menuconfig** для вашего нового профиля `Rax3000m Source Build`.
3.  Билдер начнет скачивать исходники. Дождитесь появления синего окна `menuconfig`, ничего в нем не меняйте, просто сразу выберите `< Exit >` и сохраните конфигурацию.
4.  Теперь идите в папку `firmware_output/sourcebuilder/rax3000m_source_build/`. Там вы найдете файл `manual_config`. **Полностью замените его содержимое** содержимым вашего файла `rax3000m_base.config` из Шага 2.

#### Шаг 4: Расширение конфига и финальная настройка

1.  Снова выберите в меню Билдера опцию **[C] Menuconfig** для того же профиля.
2.  Теперь OpenWrt увидит ваш "подмененный" минималистичный конфиг и **автоматически рассчитает и добавит все необходимые зависимости**.
3.  Вы снова увидите синее окно `menuconfig`, но на этот раз оно будет содержать полную, развернутую конфигурацию. Здесь вы можете внести свои финальные правки, если нужно (например, добавить пакеты через `LuCI -> Applications`). Но лучше на этапе тестирования и запуска пока ничего не менять, а ограничится только запуском MenuConfig и выходом из него.
4.  Сохраните конфигурацию при выходе в файл по умолчанию `.config` (`< Save >`, затем `< Exit >`).

#### Шаг 5: Финальная сборка

Теперь, когда у вас есть полностью готовый и корректный `.config`, выберите в главном меню ваш профиль по номеру, чтобы запустить саму сборку.
Наберитесь терпения — первая компиляция будет долгой.

---

**Итог:** Вы освоили самый надежный способ сборки сложных и кастомных прошивок, который гарантирует учет всех зависимостей и рекомендаций автора исходников. Этот метод значительно надежнее, чем простое редактирование `SRC_EXTRA_CONFIG`.
В следующем продвинутом уроке мы покажем как встраивать свои файлы в SourceBuild и как работать с файлами и VerMagic сборки.