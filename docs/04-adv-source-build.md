# Урок 4: Продвинутый Source-режим: патчи, хаки и свои пакеты (СЫРОЙ!)

**Цель:** Изучить мощные возможности кастомизации, которые предоставляет `Source Builder`: добавление сторонних пакетов, применение патчей и решение проблемы совместимости модулей (`vermagic`).

---

### 1. Внедрение кастомных конфигов и программ

Этот функционал работает в режиме `Source Builder` точно так же, как и в "быстром" режиме, который мы рассмотрели в Уроке 2.

*   **Для файлов конфигурации:** Используйте папку `custom_files/<имя_профиля>/`. Все файлы из нее будут скопированы в корень прошивки с сохранением структуры.
*   **Для готовых `.ipk` пакетов:** Пока нет механики внедрения в исходники именно уже собранных IPK. `SourceBuilder` модульб нацелен на сборку исходников.
Используйте папку `src_packages/`. Все подпапки с исходниками в этой папке файлы будут собраны а если в профиле есть такие пакеты то и автоматически встроены в прошивку.
Ниже подробнее об этом.

### 2. Добавление сторонних программ из исходников (теория)

Что делать, если нужной вам программы нет в официальном репозитории OpenWrt? Ее можно скомпилировать вместе с прошивкой.

1.  Перейдите в папку `src_packages/` в корне Билдера.
2.  Склонируйте в нее репозиторий с исходным кодом нужной программы. Например:
    ```bash
    cd src_packages
    git clone https://github.com/user/cool-package.git
    ```
3.  Запустите Билдер и выберите **[C] Menuconfig** для вашего профиля.
4.  Найдите новый пакет в меню (обычно в разделах `Utilities`, `Network` или `LuCI -> Applications`) и отметьте его для включения в сборку (клавиша `Y` или `M`).
5.  Сохраните конфигурацию и запустите сборку. Билдер сам скомпилирует пакет и добавит его в прошивку.
ЭТОТ ФУНКЦИОНАЛ ЕЩЁ НЕ ТЕСТИРОВАЛСЯ!

### 3. Решение проблемы `vermagic` (The Vermagic Hack)

**Проблема:** Если вы собираете ядро из исходников, а потом пытаетесь установить модуль ядра (`kmod-*.ipk`) из официального репозитория OpenWrt, система откажется его ставить, ругаясь на `vermagic mismatch`. Это происходит потому, что "магическая версия" вашего самосборного ядра не совпадает с той, с которой собирались официальные пакеты.

**Решение:** Билдер решает это автоматически с помощью скрипта `scripts/hooks.sh`.

*   **Как это работает:** Перед началом сборки скрипт скачивает из официальных репозиториев OpenWrt специальный файл-манифест для вашей версии и архитектуры. Из этого файла он извлекает "правильную" версию `vermagic` и "подменяет" ее в конфигурации вашей сборки.
*   **Результат:** Ваша прошивка компилируется с той же версией ядра, что и официальная. Вы можете без проблем устанавливать `kmod` пакеты из репозиториев, как если бы у вас стояла стоковая прошивка.

Как воспользоваться: файл `hooks.sh` из папки `\scripts\` нужно поместить в папку корня прошивки `\custom_files\rax3000m_emmc_test_new`.
Файл не попадёт в итоговую сборку не в режиме ImageBuilder ни в режиме SourceBuilder.
Внутри файла уже готовы инструкции которые если смогут то автоматически заменять VerMagic на актуальный.
Если вы после хака удалите этот файл то при следующей сборке исходники в области VerMagic автоматически откатятся на состояние по умолчанию.
**В итоге Вам почти ничего не нужно делать, VerMagic с hooks.sh работает "из коробки" для стабильных релизов!**

### 4. Применение патчей

Если вам нужно изменить исходный код OpenWrt или какого-то пакета, вы можете использовать патчи.

Скрипт `scripts/hooks.sh` — в первой своей части - это образец такого кода, предназначенного для таких модификаций.

**Пример, как добавить применение патча:**

1.  Создайте файл патча, например `my-fix.patch`.
2.  Положите его в удобное место, например, в корень Билдера.
3.  Откройте `scripts/hooks.sh` и найдите секцию "ТИПОВЫЕ ЗАДАЧИ".
4.  Добавьте туда команду для применения патча. `-p1` означает, что нужно отрезать один уровень вложенности пути из файла патча.

    ```bash
    # ...внутри файла scripts/hooks.sh...

    log ">>> Применяем кастомные патчи..."
    patch -p1 < /builder/my-fix.patch
    log "Кастомные патчи применены."

    # ======================================================================================
    # БЛОК 1: Демонстрационный пример...
    ```
    *(Путь `/builder/` — это путь внутри Docker-контейнера, который соответствует корню вашего проекта)*.

Теперь при каждой сборке из исходников ваш патч будет автоматически применяться к исходному коду перед компиляцией.
Чтобы патч ничего не ломал надо просить ИИ делать его ИДЕМПОТЕНТНЫМ - применяющимся только один раз.