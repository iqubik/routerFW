# Урок 4: Продвинутый Source-режим: патчи, кэш и свои пакеты

**Цель:** Изучить мощные, но неочевидные возможности `Source Builder` для полного контроля над прошивкой.

---

### 1. Добавление сторонних пакетов из исходников (ИМЕННО ЭТОТ ФУНКЦИОНАЛ ЕЩЁ НЕ ТЕСТИРОВАЛСЯ!)

Если нужной вам программы нет в официальных репозиториях, но ее исходный код доступен (например, на GitHub), вы можете скомпилировать ее вместе с прошивкой.

1.  Перейдите в папку `src_packages/` в корне Билдера.
2.  Склонируйте в нее репозиторий с исходным кодом программы:
    ```bash
    cd src_packages
    git clone https://github.com/some-author/cool-openwrt-package.git
    ```
3.  Запустите `_Builder.bat` и выберите **[C] Menuconfig** для вашего профиля.
4.  В меню конфигурации найдите новый пакет (обычно в разделах `Utilities`, `Network` или `LuCI -> Applications`) и отметьте его для включения в сборку:
    *   `<M>` — собрать как модуль (`.ipk` пакет).
    *   `<*>` — встроить прямо в прошивку.
5.  Сохраните конфигурацию и запустите основную сборку. Билдер сам скомпилирует пакет и добавит его в прошивку.

### 2. Патчи и Фиды через `hooks.sh`

Скрипт `scripts/hooks.sh` — это мощный инструмент, который выполняется **перед каждой сборкой** в режиме `Source Builder`. Он позволяет автоматизировать рутинные задачи.

*   **Применение патчей:** Если вам нужно исправить баг или изменить поведение в исходном коде, создайте `.patch` файл и положите его в корень проекта. Затем в `scripts/hooks.sh` добавьте команду его применения. Скрипт-пример уже содержит заготовку.

    ```bash
    # ...внутри файла scripts/hooks.sh...
    log ">>> Применяем кастомные патчи..."
    patch -p1 < /builder/my-fix.patch # /builder/ - это корень проекта внутри контейнера
    ```

*   **Добавление фидов (внешних репозиториев):** В `hooks.sh` есть функция `add_feed`. Вы можете раскомментировать или добавить новые строки для подключения целых репозиториев с пакетами, которых нет в OpenWrt. Пример из скрипта:
    ```bash
    # Добавляет репозиторий с пакетом amneziawg
    add_feed "amneziawg" "https://github.com/amnezia-vpn/amnezia-wg-openwrt.git"
    ```

### 3. Решение проблемы `vermagic` (The "Vermagic Hack")

**Проблема:** Вы собрали свою прошивку, но не можете установить модули ядра (`kmod-*.ipk`) из официального репозитория — система ругается на `vermagic mismatch` (несовпадение версий ядра).

**Решение в Билдере:** Эта проблема решается **автоматически** для релизных сборок. Скрипт `hooks.sh` сам определяет вашу версию OpenWrt, скачивает официальную "подпись" ядра (`vermagic`) и встраивает ее в вашу сборку.

Как воспользоваться: файл `hooks.sh` из папки `\scripts\` нужно поместить в папку корня прошивки `\custom_files\rax3000m_emmc_test_new`.
Файл не попадёт в итоговую сборку не в режиме ImageBuilder ни в режиме SourceBuilder.
Внутри файла уже готовы инструкции которые если смогут то автоматически заменять VerMagic на актуальный.
Если вы после хака удалите этот файл то при следующей сборке исходники в области VerMagic автоматически откатятся на состояние по умолчанию.
**В итоге Вам почти ничего не нужно делать, VerMagic с hooks.sh работает "из коробки" для стабильных релизов!** Просто знайте, что благодаря этому вы можете ставить официальные `kmod` пакеты на свою кастомную `Source` прошивку.

### 4. Управление кэшем и решение проблем

Иногда после неудачной сборки или смены конфигурации кэш может "засориться", что приводит к странным ошибкам. Билдер имеет встроенное меню для очистки.

**Как пользоваться:** В главном меню выберите **[C] CLEAN / MAINTENANCE**. Убедитесь, что вы находитесь в режиме `SOURCE BUILDER`, и вы увидите следующие опции:

*   **[1] SOFT CLEAN (make clean):** "Первая помощь". Удаляет скомпилированные файлы для выбранного профиля, но оставляет исходники и тулчейн. Идеально, если сборка упала на середине.
*   **[2] HARD RESET (Удалить src-workdir):** Удаляет всю папку с исходниками для профиля. Используйте, если исходный код повредился или нужно начать "с чистого листа". Загруженные архивы (`dl`) и `ccache` сохранятся.
*   **[3] Очистить кэш исходников (dl):** Удаляет все скачанные архивы пакетов. Полезно для освобождения места. При следующей сборке они будут скачаны заново.
*   **[4] Очистить CCACHE:** Полностью сбрасывает кэш компилятора. Следующая сборка будет такой же долгой, как и самая первая. Используйте, если подозреваете проблемы с компилятором.
*   **[5] FULL FACTORY RESET:** "Ядерный вариант". Удаляет для профиля **всё**: исходники, кэш `dl` и `ccache`.
*   **[9] Prune Docker:** Глобальная команда Docker для очистки всей системы от неиспользуемых образов, сетей и кэшей. Полезна для общего обслуживания.

**Рекомендация:** При возникновении проблем начинайте с `SOFT CLEAN`. Если не помогло — `HARD RESET`.

---
Это завершает цикл уроков. Теперь у вас есть все знания для создания прошивок любой сложности!