Наверняка много кто хотел иметь персональный бинарник роутера с полным конфигом и кастомными пакетами. Не просто резервная копия, а прямо откат версию в bin!

Я себе соорудил конвейер по сборке прошивок через билдер в докер контейнерах с помощью docker desktop под win11 и собирает он мило и бодро.
Собирает как старые так и новые версии openwrt: 19 версию на спец докер образе в старом окружении а 24 современную в свежем.
Все сборки идут с умным кэшированием благодаря чему время повторной сборки сокращается до ~30 секунд а время первичной сборки составит до 2 минут (ну и на первый старт окружения надо ещё минут 5).

Ниже описание версии для массового использования.
Не пугайтесь base64 вставок их можно расшифровать онлайн и убедится, что всё как надо.

Интерфейс:
 # 
========================================
OpenWrt Smart Builder v4.0 (iqubik)
========================================

Обнаруженные профили:

[1] example_841n.conf
[2] giga.conf
[3] nanopi-r5c.conf

[A] Собрать ВСЕ профили (Параллельно)
[0] Выход

Описание:
Автономная система сборки прошивок в одном bat файле.
Собирает в двух разных окружениях старые и новые прошивки с помощью docker desktop. Тестировалась и разрабатывалась на win11.
Умеет собирать прошивки по данным профиля, сама находит профили в папке профилей.

custom_packages - папка для кастомных ipk. Просто кидаем их сюда а в профиле указываем верное имя пакета и они запекутся в прошивку.
custom_files/название_профиля - корень вашей прошивки, если сюда распаковать родной backup с openwrt то получится, что прошивка выйдет заранее настроенной.
firmware_output/название_профиля - тут будут лежать ваши прошивки с timestamp времени сборки в имени файла.
profiles - папка профилей сборки.
Все папки, подпапки и файлы bat файл создаст сам при первом запуске.

Пример профиля:
#имя профиля нижний регистр
PROFILE_NAME="example_841n"
#цель сборки
TARGET_PROFILE="tl-wr841-v9"
#пакет для сборки
IMAGEBUILDER_URL="https://downloads.openwrt.org/releases/19.07.9/targets/ar71xx/tiny/openwrt-imagebuilder-19.07.9-ar71xx-tiny.Linux-x86_64.tar.xz"
#список пакетов добавить люси убрать opkg
PKGS="luci-base -opkg"
#размер корня в МБ
ROOTFS_SIZE="512"


Приятного использования!

===
UPD. Добавлен Power Shell скрипт create_profile.ps1 который помогает сформировать нужный профиль для сборки через парсинг оффсайта
Сам ps1 скрипт просто так не запустить - политика безопасности win. Для его запуска используйте _run_create_profile.bat

===
Q. - Возможно ли в этом инструменте сборки изменять размер свободного места? К примеру сейчас доступного места 100мб можно например изменить его в собранном образе на 200мб.
A. = Да. Начиная с версии 4 инструмента можно в профиль добавлять ROOTFS_SIZE=""

===

Q. - При попытке запенить в списке пакетов пакет: dnsmasq на dnsmasq-full, выдаёт ошибку. Подскажите, пожалуйста, есть ли возможность её исправить?
A. - По поводу полных версий пакетов. как я понял методика такая: в готовой прошивке 7z в /usr/lib/opkg есть файл status - там все пакеты и зависимости к ним. под некоторыми написано autoinstalled yes - значит какой то другой пакет затребовал установку именно этого. Идея в том чтобы найти виновника и поставить только нужные его части, а в списке пакетов указать -dnsmasq добавив минус вначале пакета а потом dnsmasq-full

===
Так же тут есть папка с интересными скриптами:
scripts\diag.sh - скрипт чтобы отдать данные его диагностики в нейронку и получить ответы. Собирает максимум данных о системе но скрывает все пароли.
scripts\packager.sh - вспомогательный скрипт что в папке /etc/config создаёт файлы status и status_lite с полным и сокращенным списков пакетов этой системы
scripts\upgrade.sh - ну это такое, просто обновлялка всех пакетов аналог apt upgrade в debian.
