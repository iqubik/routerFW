# Аудит загрузки роутера (профиль rax3000m_emmc_test_new)

Начало анализа лог-файла `debug.md`.

---
## Анализ строк 1-200

**Ключевые моменты:**

1.  **Инициализация ядра:**
    *   Успешно стартует ядро Linux версии `6.6.95`, собранное `Sun Feb  1 15:34:30 2026`.
    *   Сборка определена как OpenWrt (GCC 13.3.0, r0+33480-082203ae45).
    *   Машина идентифицирована как `CMCC RAX3000M eMMC (MTK UBoot)`, что соответствует профилю.

2.  **Параметры загрузки и хранилище:**
    *   **Командная строка ядра:** `root=/dev/mmcblk0p5 rootwait`. Это критически важный параметр, указывающий, что корневая файловая система находится на 5-м разделе (`p5`) встроенной памяти eMMC (`mmcblk0`).
    *   **eMMC:** Обнаружена карта eMMC `SCA64G` объемом `58.2 GiB`, разбитая на 7 разделов. Это подтверждает, что устройство использует встроенную память, а не NAND/SPI-флеш.

3.  **Сетевая подсистема:**
    *   **Ethernet:** Инициализируется драйвер `mtk_soc_eth` и свитч `mt7530-mdio`. Один из портов показывает активность на скорости `2.5Gbps`.
    *   **Ошибки MTU:** Зафиксированы неопасные ошибки (`nonfatal error -34`, `error -22`) при установке MTU. Это типичное явление для драйверов Mediatek DSA в OpenWrt и не влияет на работу.
    *   **Wi-Fi чип:** Обнаружено PCI-устройство `14c3:7981`, которое является Wi-Fi чипом `MediaTek MT7981`.

4.  **Монтирование и запуск системы:**
    *   Корневая ФС (`squashfs`) успешно смонтирована в режиме "только для чтения" с раздела `179:5` (что соответствует `mmcblk0p5`).
    *   Запущен процесс `/sbin/init`, который начинает запуск пользовательского окружения.

5.  **Сторонние модули ядра:**
    *   Загружается модуль `conninfra`, который является проприетарным (out-of-tree) и "заражает" ядро (`taints kernel`). Это ожидаемое поведение, так как данный модуль необходим для работы специфичного оборудования Mediatek (Wi-Fi, аппаратное ускорение и т.д.). Далее в логе идет детальная инициализация этим модулем различных аппаратных блоков.

**Вывод по первому блоку:**
Загрузка ядра проходит штатно. Система корректно идентифицирует оборудование (процессор, eMMC, сетевые интерфейсы). Параметры загрузки соответствуют конфигурации для устройства с eMMC. Начальная инициализация сетевой подсистемы и загрузка проприетарных драйверов Mediatek проходят успешно.

---
## Анализ строк 201-400

**Ключевые моменты:**

1.  **Завершение инициализации `conninfra`:**
    *   Модуль продолжает низкоуровневую настройку Wi-Fi, считывая eFuse (встроенную память чипа) и записывая конфигурационные значения через SPI.
    *   Однозначно идентифицирован чип: `A-die CHIP ID = 0x7976` и `SKU Type: 3000`.
    *   Завершается процесс включением питания на Wi-Fi блок (`WF=[1]`).

2.  **Обнаружение внешнего диска:**
    *   `usb 2-1: new SuperSpeed USB device number 2 using xhci-mtk`: К порту USB 3.0 подключено устройство.
    *   `scsi 0:0:0:0: Direct-Access JMicron Tech 4101`: Это внешний диск в корпусе на чипе JMicron.
    *   `[sda] 468862128 512-byte logical blocks: (240 GB/224 GiB)`: Обнаружен SSD объемом 240 ГБ.
    *   `xhci-mtk 11200000.usb: ERROR Transfer event for unknown stream`: Зафиксирована ошибка USB-контроллера. Хотя диск и определился, эта ошибка может указывать на потенциальные проблемы со стабильностью USB под нагрузкой. Требует наблюдения.

3.  **Монтирование OverlayFS (ключевой этап):**
    *   `F2FS-fs (mmcblk0p6): Mounted`: Система монтирует 6-й раздел eMMC (`p6`), отформатированный в `F2FS`.
    *   `mount_root: switching to f2fs overlay`: Это подтверждение того, что система успешно переключилась на использование раздела `p6` в качестве `overlay`. Теперь все изменения конфигурации будут сохраняться на этот раздел, обеспечивая персистентность данных.

4.  **Аппаратное ускорение (HNAT):**
    *   Загружен модуль `mediatek_soc_hnat`. Это ядро системы аппаратного NAT, которое позволяет обрабатывать трафик без участия ЦП.
    *   Загружены и запущены модули `WARP` (`warp_module_init`) и `WED` (Wireless Ethernet Dispatch). Они отвечают за аппаратное ускорение Wi-Fi трафика, что критически важно для достижения высоких скоростей.

5.  **Инициализация Wi-Fi драйвера:**
    *   Начинается запуск основного драйвера Wi-Fi (`mt7981_init`).
    *   Сообщение `Use the default iPAiLNA bin image!` говорит об использовании стандартного firmware для усилителей сигнала.

6.  **Активация SWAP:**
    *   `Adding 2097148k swap on /dev/mmcblk0p7`: Система успешно активировала раздел подкачки размером 2 ГБ на 7-м разделе eMMC (`p7`). Это значительно повышает стабильность системы при нехватке оперативной памяти.

**Вывод по второму блоку:**
Система успешно завершила этап `preinit`. Корневая файловая система (overlay) корректно смонтирована на F2FS-раздел eMMC. Обнаружен внешний SSD, хотя и с ошибкой в логе USB. Важнейшие компоненты для производительности — аппаратный NAT и ускорение Wi-Fi — загружены. Началась инициализация Wi-Fi драйвера. Активирован раздел подкачки. Система сконфигурирована правильно.
---
## Анализ строк 401-600

**Ключевые моменты:**

*   **ZRAM Swap**: Активирован высокоприоритетный ZRAM swap (`priority 100`) размером 256MB в дополнение к дисковому swap. Это отличная оптимизация производительности, так как более быстрая подкачка в RAM будет использоваться в первую очередь.
*   **Сетевой мост**: LAN-порты (`lan1`, `lan2`, `lan3`) успешно объединены в сетевой мост `br-lan`.
*   **Прошивка Wi-Fi Offload**: Прошивка для сопроцессора `WO` (Wi-Fi Offload) с датой сборки `20221208` успешно загружена. Это необходимое условие для работы аппаратного ускорения Wi-Fi.
*   **Патч Wi-Fi**: Драйвер загружает очень свежий микрокод-патч для чипа Wi-Fi (дата сборки `20240613`), что гарантирует наличие последних исправлений.
*   **Конфигурация Wi-Fi**: Драйвер начинает применять пользовательские настройки (выбор канала, безопасность и т.д.).
*   **Статус**: Инициализация подсистем сети и Wi-Fi проходит корректно, включая загрузку всех необходимых прошивок и патчей. Подробные предупреждения о таймаутах выглядят как низкоприоритетный отладочный "шум" и не должны влиять на работу.

**Вывод по третьему блоку:**
Система настроила многоуровневый swap (ZRAM + диск), что является продвинутой и правильной конфигурацией. Прошивки для Wi-Fi и его сопроцессора успешно загружены, причём используется свежий патч от июня 2024. Сетевой мост для LAN создан. Началась конфигурация Wi-Fi в соответствии с настройками. Несмотря на "шумные" предупреждения в логе, инициализация Wi-Fi проходит по плану.
---
## Анализ строк 601-800

**Ключевые моменты:**

*   **Автовыбор канала 2.4ГГц**: Драйвер инициирует и выполняет полное сканирование всех 13 каналов в диапазоне 2.4ГГц для поиска наименее загруженного.
*   **Выбор канала**: На основе сканирования (`SelectClearChannelBusyTime`) алгоритм определяет, что канал `12` имеет наименьшее время занятости (`Busy Time = 3621`), и выбирает его для работы. Это говорит о корректной работе функции автовыбора.
*   **Настройка канала**: Радиомодуль настраивается на работу на 12-м канале с шириной 40МГц.
*   **Поднятие интерфейса `ra0`**: Основной интерфейс точки доступа 2.4ГГц (`ra0`) создается, ему присваивается MAC-адрес `c8:75:f4:69:9d:b4`, и он успешно регистрируется в системе аппаратного ускорения (`mtk_ppe_dev_register_hook`).
*   **Аномалия с "хлопаньем" интерфейса**: Сразу после поднятия интерфейса `ra0` следует последовательность команд на его отключение (`VIRTUAL_INF_DOWN`, `ap_link_down`). Это необычно, но, скорее всего, является частью сложного скрипта `netifd` в OpenWrt, который сначала поднимает интерфейс для чтения его параметров, а затем переконфигурирует его перед финальным запуском. Это требует внимания, но, вероятно, не является ошибкой.

**Вывод по четвертому блоку:**
Ключевое событие этого этапа — успешная работа механизма автоматического выбора канала для диапазона 2.4 ГГц, который выбрал оптимальный канал (12) на основе анализа радиоэфира. Интерфейс `ra0` был успешно инициализирован и подключен к аппаратному ускорителю. Замечена странная последовательность выключения/включения интерфейса, которая, вероятно, является технической особенностью процесса настройки в OpenWrt.
---
## Анализ строк 801-1000

**Ключевые моменты:**

*   **Подтверждение "хлопанья" интерфейса**: Этот блок лога полностью подтверждает аномалию, замеченную ранее. Происходит полный цикл остановки и деинициализации интерфейса `ra0` и всего стека аппаратного ускорения (`WARP`/`WED`).
    *   `mtk_ppe_dev_unregister_hook`: Интерфейс отключается от аппаратного ускорителя.
    *   `warp_client_remove()`: Клиент `WARP` удаляется.
*   **Повторная инициализация**: Сразу после отключения начинается полная повторная инициализация.
    *   `CMD_RTPRIV_IOCTL_VIRTUAL_INF_INIT`: Команда на инициализацию нового виртуального интерфейса.
    *   Заново загружается прошивка для Wi-Fi Offload (`WO Firmware`).
    *   Заново загружается микрокод-патч для чипа (`E1 ROM patch`).
*   **Повторная конфигурация**: Скрипты заново применяют настройки из `config/wireless`.
    *   `AutoChannelAtBootup=1` для диапазона 0 (2.4ГГц).
    *   `AutoChannelAtBootup=0` для диапазона 1 (5ГГц), что подтверждает использование фиксированного канала для 5ГГц.
*   **Второе сканирование каналов**: Лог показывает, что система инициирует **второе** сканирование каналов 2.4ГГц (`ApAutoChannelAtBootUp()`). Это избыточно, так как сканирование уже проводилось, но подтверждает, что это заложено в логику стартовых скриптов.

**Вывод по пятому блоку:**
Процесс запуска Wi-Fi в данной прошивке является избыточным и неэффективным. Он включает в себя полный цикл "поднять-отключить-поднять заново" для интерфейса 2.4ГГц, включая двойную загрузку firmware/патчей и двойное сканирование эфира. Хотя это и приводит к более долгой загрузке, процесс завершается без фатальных ошибок. Вероятнее всего, это является побочным эффектом взаимодействия стандартного демона `netifd` из OpenWrt и проприетарных скриптов Mediatek. Система функционирует, но с точки зрения оптимизации загрузки есть явные недочеты.
---
## Анализ строк 1001-1200

**Ключевые моменты:**

*   **Избыточное сканирование 2.4ГГц**: Лог подтверждает, что драйвер выполняет второе полное сканирование каналов 2.4ГГц. Результаты снова показывают, что канал 12 является наименее загруженным (`Busy Time = 3433`), и драйвер снова выбирает его.
*   **Финальный запуск `ra0` (2.4ГГц)**:
    *   Интерфейс `ra0` окончательно настраивается на 12-й канал.
    *   `bcn offload=1`: Подтверждается, что маячковые кадры (beacons) обрабатываются аппаратно, что снижает нагрузку на CPU.
    *   `mtk_ppe_dev_register_hook`: Интерфейс `ra0` во второй раз регистрируется в системе аппаратного ускорения.
    *   `br-lan: port 4(ra0) entered forwarding state`: Интерфейс `ra0` добавляется в мост `br-lan` и начинает пересылать трафик. **Сеть 2.4ГГц полностью готова к работе.**
*   **Запуск `rax0` (5ГГц)**:
    *   Начинается инициализация второго радиоинтерфейса `rax0` (`wdev idx = 1`).
    *   `ACS is disable !!`: Как и было настроено, автоматический выбор канала для 5ГГц отключен.
    *   Драйвер настраивает радио на канал `36` с шириной `160МГц` ( `vht_bw(2)` + `bw(3)` => 160MHz) с центральным каналом `50`. Это конфигурация для высокой производительности.
    *   `mtk_ppe_dev_register_hook : ineterface rax0 register (2)`: Интерфейс `rax0` также успешно регистрируется в системе аппаратного ускорения. **Сеть 5ГГц полностью готова к работе.**
*   **Инициализация третьего интерфейса (VAP)**:
    *   `wdev idx = 3`: Начинается инициализация третьего виртуального интерфейса (Virtual AP).
    *   Он настраивается на тот же канал 5ГГц (36 @ 160MHz), что и `rax0`.
    *   Ему присваивается новый MAC-адрес (`c2:75:f4:69:9d:b4`). Это, скорее всего, гостевая или IoT-сеть, работающая на том же радиомодуле, что и основная сеть 5ГГц.

**Вывод по шестому блоку:**
Несмотря на избыточную двойную инициализацию, интерфейс 2.4ГГц (`ra0`) успешно запущен и работает. Следом за ним успешно запущен и основной интерфейс 5ГГц (`rax0`) на предустановленном канале 36 с шириной 160МГц. Оба интерфейса подключены к аппаратному ускорению. Началась настройка дополнительной виртуальной точки доступа в диапазоне 5ГГц. На данном этапе обе основные Wi-Fi сети полностью работоспособны.
