# file: srcBuilder\docker-compose-src.yaml v0.9

services:
  builder-src-openwrt:
    build:
      context: .
      dockerfile: src.dockerfile
    # ЗАПУСКАЕМСЯ ОТ ROOT, ЧТОБЫ ПОЧИНИТЬ ПРАВА НА ТОМА
    user: "root"
    environment:
      - CONF_FILE=${SELECTED_CONF}
    volumes:
      - src-workdir:/home/build/openwrt
      - src-dl-cache:/home/build/openwrt/dl
      - ./src_profiles:/profiles
      - ./custom_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./openssl.cnf:/openssl.cnf
    command: &src_build_script |
      /bin/bash -c "
      set -e
      echo '[INIT] Checking volume permissions...'
      # Используем $$(...) чтобы docker-compose не пытался интерпретировать переменную
      if [ \"$$(stat -c '%U' /home/build/openwrt)\" != \"build\" ]; then
          echo \"[INIT] First run detected: Fixing ownership of workdir...\"
          chown -R build:build /home/build/openwrt
      fi
      
      # Создаем скрипт сборки внутри контейнера
      cat << 'EOF' > /tmp/build_script.sh      
      set -e
      export HOME=/home/build
      
      # Вычисляем ID профиля из имени файла конфига (для красивого лога в конце)
      PROFILE_ID=$$(basename \"$$CONF_FILE\" .conf)

      # === 0. Setup Environment ===
      if [ ! -f \"/profiles/$$CONF_FILE\" ]; then
        echo \"FATAL: Profile /profiles/$$CONF_FILE not found!\"
        exit 1
      fi
      
      # Fix CRLF
      tr -d '\\r' < \"/profiles/$$CONF_FILE\" > /tmp/clean_config.env
      source /tmp/clean_config.env
      
      echo \"==================================================\"
      echo \"   OpenWrt SOURCE Builder for $$PROFILE_NAME\"
      echo \"==================================================\"
      
      START_TIME=$$(date +%s)
      TIMESTAMP=$$(TZ='UTC-3' date +%d%m%y-%H%M%S)
      
      # === 1. GIT SETUP ===
      if [ ! -d \".git\" ]; then
          echo \"[GIT] Initializing repo in non-empty dir...\"
          # Убираем надоедливое предупреждение о ветке master/main
          git config --global init.defaultBranch master
          git init
          git remote add origin \"$$SRC_REPO\"
      fi
      
      echo \"[GIT] Fetching $$SRC_BRANCH...\"
      git fetch origin \"$$SRC_BRANCH\"
      
      echo \"[GIT] Checkout/Reset to $$SRC_BRANCH...\"
      # Отключаем лишний шум в логах
      git config --global advice.detachedHead false
      git checkout -f \"FETCH_HEAD\"
      git reset --hard \"FETCH_HEAD\"

      # === FIX: SWITCH TO GITHUB MIRRORS ===
      # Сервер openwrt.org часто падает (503), меняем на GitHub
      if [ -f feeds.conf.default ]; then
          echo \"[FIX] Switching feeds to GitHub mirrors...\"
          sed -i 's|https://git.openwrt.org/feed/|https://github.com/openwrt/|g' feeds.conf.default
          sed -i 's|https://git.openwrt.org/project/|https://github.com/openwrt/|g' feeds.conf.default
      fi

      # === 2. FEEDS ===
      echo \"[FEEDS] Updating and Installing feeds...\"
      ./scripts/feeds update -a
      ./scripts/feeds install -a

      # === CUSTOM SOURCES ===
      # ВАЖНО: Сюда нужно класть ПАПКИ с исходниками (Makefile), а не .ipk файлы!
      if [ -d \"/input_packages\" ] && [ \"$$(ls -A /input_packages)\" ]; then
          echo \"[PKG] Injecting custom sources into package/ directory...\"
          cp -rf /input_packages/* package/
      fi

      # === 3. CONFIGURATION ===
      echo \"[CONFIG] Generating .config...\"
      rm -f .config
      
      # Базовая конфигурация Target
      echo \"CONFIG_TARGET_$$SRC_TARGET=y\" >> .config
      echo \"CONFIG_TARGET_$${SRC_TARGET}_$${SRC_SUBTARGET}=y\" >> .config
      echo \"CONFIG_TARGET_$${SRC_TARGET}_$${SRC_SUBTARGET}_DEVICE_$$SRC_DEVICE=y\" >> .config
      
      # Добавляем пользовательские пакеты из SRC_PACKAGES
      # Логика: если пакет начинается с '-', это # CONFIG_PACKAGE_x is not set
      # Иначе CONFIG_PACKAGE_x=y
      for pkg in $$SRC_PACKAGES; do
          if [[ \"$$pkg\" == -* ]]; then
              clean_pkg=\"$${pkg#-}\"
              echo \"# CONFIG_PACKAGE_$$clean_pkg is not set\" >> .config
          else
              echo \"CONFIG_PACKAGE_$$pkg=y\" >> .config
          fi
      done
      
      # Apply LUCI default (если пользователь не указал его сам)
      # ВАЖНО: Кавычки экранированы \", чтобы bash -c их не съел
      if ! grep -q \"CONFIG_PACKAGE_luci=y\" .config; then
          echo \"CONFIG_PACKAGE_luci=y\" >> .config
      fi
      
      # Sizes
      if [ -n \"$$SRC_ROOTFS_SIZE\" ]; then
        echo \"CONFIG_TARGET_ROOTFS_PARTSIZE=$$SRC_ROOTFS_SIZE\" >> .config
      fi

      if [ -n \"$$SRC_KERNEL_SIZE\" ]; then
        echo \"CONFIG_TARGET_KERNEL_PARTSIZE=$$SRC_KERNEL_SIZE\" >> .config
      fi

      echo \"[DEBUG] Showing generated SEED .config:\"
      echo \"----------------------------------------\"
      cat .config
      echo \"----------------------------------------\"
      make defconfig
      
      # === 4. CUSTOM FILES ===
      if [ -d \"/overlay_files\" ] && [ \"$$(ls -A /overlay_files)\" ]; then
          echo \"[FILES] Copying overlay files...\"
          mkdir -p files
          cp -r /overlay_files/* files/
      fi
      
      # === 5. DOWNLOAD ===
      echo \"[DOWNLOAD] Downloading sources to cache...\"
      mkdir -p dl
      # Пробуем скачать молча. Если ошибка — повторяем с подробным выводом (V=s) и останавливаемся
      make download || (echo \"[ERROR] Download failed! Retrying with logging...\" && make download V=s && exit 1)
      
      # === 6. BUILD ===
      echo \"[BUILD] Starting compilation (Jobs: $$(nproc))...\"
      # Пытаемся собрать многопоточно, при ошибке - однопоточно с логами
      make -j$$(nproc) || (echo \"[ERROR] Multicore build failed. Retrying single core V=s...\" && make -j1 V=s)
      
      # === 7. ARTIFACTS ===
      echo \"[SAVE] Saving artifacts...\"
      TARGET_DIR=\"/output/$$TIMESTAMP\"
      mkdir -p \"$$TARGET_DIR\"
      
      # Ищем файлы в bin/targets
      find bin/targets/$$SRC_TARGET/$$SRC_SUBTARGET -maxdepth 2 -type f \\( -name \"*.bin\" -o -name \"*.img\" -o -name \"*.iso\" \\) -exec cp {} \"$$TARGET_DIR/\" \\;
      
      # Сохраняем итоговый конфиг для справки
      cp .config \"$$TARGET_DIR/build.config\"
      
      END_TIME=$$(date +%s)
      ELAPSED=$$((END_TIME - START_TIME))
      
      echo \"\"
      echo \"============================================================\"
      echo \"=== Сборка $$PROFILE_NAME завершена за $${ELAPSED}с.\"
      echo \"=== Образы: firmware_output/$$PROFILE_ID/$$TIMESTAMP\"
      echo \"============================================================\"
      EOF
      
      chmod +x /tmp/build_script.sh
      chown build:build /tmp/build_script.sh
      
      echo '[EXEC] Switching to user build...'
      sudo -E -u build bash /tmp/build_script.sh
      "

  builder-src-oldwrt:
    build:
      context: .
      dockerfile: src.dockerfile.legacy
    user: "root"
    environment:
      - CONF_FILE=${SELECTED_CONF}
    volumes:
      - src-workdir:/home/build/openwrt
      - src-dl-cache:/home/build/openwrt/dl
      - ./src_profiles:/profiles
      - ./custom_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./openssl.cnf:/openssl.cnf
    command: *src_build_script

volumes:
  src-dl-cache:
  src-workdir: