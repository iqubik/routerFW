# Аудит изменений: текущая версия относительно тега 4.3

**Базовый тег:** `4.3` (2026-02-06, коммит d914ff1)  
**Текущее состояние:** `4.32-18-g5388320` (HEAD: 5388320, 2026-02-16)  
**Всего коммитов:** 36

---

## 1. Сводка по репозиторию

| Метрика | Значение |
|--------|----------|
| Коммитов после 4.3 | 36 |
| Файлов изменено | 27 |
| Строк добавлено | ~9 669 |
| Строк удалено | ~7 872 |

---

## 2. Изменённые файлы по категориям

### 2.1 Конфигурация и инфраструктура

| Файл | Статус | Описание |
|------|--------|----------|
| `.gitattributes` | M | Добавлены LFS и нормализация: `*.zst`, `*.tar`, `*.gz`, `*.bin`, `*.7z` → `filter=lfs`; разделители секций |
| `_Builder.bat` | M | Согласование с изменениями в shell-сборке |
| `_Builder.sh` | M | Версия 4.20→4.32; поддержка `custom_patches`, новая легенда (X), Stay in Container, очистка tmp, правки путей и прав |
| `_packer.bat` | M | Незначительные правки |
| `_packer.sh` | M | Расширения упаковки/логики |
| `_unpacker.bat` | M | Крупные правки (в т.ч. возможная нормализация CRLF) |
| `_unpacker.sh` | M | Крупные правки (в т.ч. возможная нормализация CRLF) |

### 2.2 Профили и сборки

| Файл | Статус | Описание |
|------|--------|----------|
| `profiles/rax3000m_emmc_test_new.conf` | M | Существенные изменения конфигурации (249± строк) |

### 2.3 Системные скрипты

| Файл | Статус | Описание |
|------|--------|----------|
| `scripts/hooks.sh` | M | Блок 1.4: патч libxcrypt (GCC 13+, `-Wno-error=format-nonliteral`) |
| `system/create_profile.ps1` | M | Мелкие правки |
| `system/ib_builder.sh` | M | v1.0→v1.2: корректное имя архива из URL, распаковка .zst/.xz, проверка `repositories.conf`, правка CUSTOM_REPOS, 3→2 попытки сборки |
| `system/import_ipk.ps1` | M | Мелкие правки |
| `system/src_builder.sh` | M | Правки логики сборки |

### 2.4 Артефакты сборки (LFS / бинарники)

**Добавлены (A):**

- `builds/rax1.2/` — imagebuilder 1.21, образы rax3000m-emmc, rax3000m, rax3000me, xr30
- `builds/rax1.22/` — immortalwrt-imagebuilder-iq_1.22-mediatek-filogic (tar.zst)
- `builds/rax1.23/` — immortalwrt-imagebuilder-iq_1.23-mediatek-filogic (tar.zst)
- `old_routerFW_LinuxDockerBuilder_v23.01.2026_04-59.tar.gz`
- `routerFW_LinuxDockerBuilder_v16.02.2026_17-31.tar.gz`
- `routerFW_WinDockerBuilder_v15.02.2026_13-21.zip`

**Удалены (D):**

- `routerFW_LinuxDockerBuilder_v23.01.2026_04-59.tar.gz` (заменён на old_*)
- `routerFW_WinDockerBuilder_v06.02.2026_16-50.zip`

### 2.5 Документация

| Файл | Статус | Описание |
|------|--------|----------|
| `pub.md` | M | История обновлений и аудитов |
| `rax_audit.md` | A | Новый файл аудита (183+ строк) |

---

## 3. Ключевые функциональные изменения

### 3.1 Builder (_Builder.sh)

- **Версия:** 4.20 → 4.32.
- **Каталог патчей:** добавлена поддержка `custom_patches/$p_id` и переменная `HOST_PATCHES_DIR`.
- **Легенда:** новый индикатор **X** (патчи) в списке профилей.
- **Source Builder:** опция «остаться в контейнере» после сборки (интерактивный shell).
- **Очистка:** новый пункт меню «Clean Package Index (tmp)»; полный сброс перенесён на пункт 6.
- **Конфиг:** умное определение устройства (Smart Device Detection), учёт `SRC_EXTRA_CONFIG`.
- **Права и каталоги:** создание `HOST_OUTPUT_DIR` через `check_dir`; смена прав только при существовании каталога.

### 3.2 Image Builder (system/ib_builder.sh)

- Имя архива берётся из URL без query-параметров (`?download=` и т.п.).
- Распаковка .zst/.xz без подавления ошибок; проверка наличия `repositories.conf` после распаковки.
- Обработка `CUSTOM_REPOS`: пустые строки и комментарии пропускаются, trailing slash в URL убирается.
- Количество попыток сборки уменьшено с 3 до 2.

### 3.3 Hooks (scripts/hooks.sh)

- **Блок 1.4:** автоматический патч `feeds/packages/libs/libxcrypt/Makefile` (добавление `TARGET_CFLAGS += -Wno-error=format-nonliteral`) для сборки с GCC 13+.

### 3.4 Git и бинарники

- В `.gitattributes` добавлено использование LFS для `*.zst`, `*.tar`, `*.gz`, `*.bin`, `*.7z`.
- Крупные изменения в `_unpacker.sh` / `_unpacker.bat` частично связаны с коммитом «fix crlf» (нормализация окончаний строк).

---

## 4. Хронология коммитов (кратко)

| Дата | Коммит | Описание |
|------|--------|----------|
| 2026-02-07 | 127e418 | docker rax3000emmc |
| 2026-02-09 | 8c5ec8b, b704701 | rax3000m_emmc_test_new.conf; fix crlf |
| 2026-02-10 | 582a1c2 … 451d629 | Обновления pub.md (несколько коммитов); 7 |
| 2026-02-12 | fe3bcea … 4b75673 | rax_audit.md, menuconfig, rax/rax3000, ib, imagebuilder 1.21 |
| 2026-02-14 | 407753d … ebc48ab | rax3000m_emmc_test_new.conf (несколько); imagebuilder 1.22; ib padavan |
| 2026-02-15 | eebe8bc, b28f43b | linux.sh upd; 123 |
| 2026-02-16 | 5388320 | fix |

---

## 5. Рекомендации для релиза

1. **Версионирование:** текущее состояние описывается как 4.32 + 18 коммитов; при создании тега (например 4.33) обновить `VER_NUM` в `_Builder.sh` и, при необходимости, в `_Builder.bat`.
2. **Проверка:** перед релизом прогнать сборку по профилю `rax3000m_emmc_test_new` (Image Builder и при необходимости Source).
3. **Артефакты:** учтены смена и перенос Docker-образов/архивов (старый Linux builder в `old_*`, новый Win builder). При публикации убедиться, что в репозитории остаются только нужные бинарники и они за LFS там, где настроено.

---

*Аудит выполнен по diff `4.3..HEAD` (git).*
