# file: srcBuilder\docker-compose-src.yaml v1.8
services:
  builder-src-openwrt:
    build:
      context: .
      dockerfile: src.dockerfile
    user: "root"
    environment:
      - CONF_FILE=${SELECTED_CONF}
      - CCACHE_DIR=/ccache
    volumes:
      - src-workdir:/home/build/openwrt
      - src-dl-cache:/home/build/openwrt/dl
      - src-ccache:/ccache
      - ./profiles:/profiles
      - ./src_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./openssl.cnf:/openssl.cnf

    command: &src_build_script |
      /bin/bash -c "
      set -e
      echo '[INIT] Checking volume permissions...'
      
      # 1. Исправление прав для рабочей папки
      if [ \"$$(stat -c '%U' /home/build/openwrt)\" != \"build\" ]; then
          echo \"[INIT] First run detected: Fixing ownership of workdir...\"
          chown -R build:build /home/build/openwrt
      fi

      # 2. FIX: Исправление прав для CCACHE (Иначе компилятор не сможет писать кэш и упадет)
      if [ -d \"/ccache\" ] && [ \"$$(stat -c '%U' /ccache)\" != \"build\" ]; then
          echo \"[INIT] Fixing ownership of /ccache volume...\"
          chown -R build:build /ccache
      fi

      # Создаем скрипт сборки внутри контейнера
      cat << 'EOF' > /tmp/build_script.sh      
      set -e
      export HOME=/home/build
      PROFILE_ID=$$(basename \"$$CONF_FILE\" .conf)

      # === 0. Setup Environment ===
      if [ ! -f \"/profiles/$$CONF_FILE\" ]; then
        echo \"FATAL: Profile /profiles/$$CONF_FILE not found!\"
        exit 1
      fi
      
      # === КОНВЕРТАЦИЯ CRLF -> LF И УДАЛЕНИЕ BOM ===
      echo \"[INIT] Normalizing config...\"
      cat \"/profiles/$$CONF_FILE\" | sed '1s/^\\xEF\\xBB\\xBF//' | tr -d '\\r' > /tmp/clean_config.env
      source /tmp/clean_config.env

      # ВАЖНО: Экспортируем переменные, чтобы hooks.sh их видел
      export SRC_REPO SRC_BRANCH SRC_TARGET SRC_SUBTARGET SRC_DEVICE PROFILE_NAME SRC_PACKAGES

      if [ -z \"$$SRC_REPO\" ]; then
         echo \"[ERROR] SRC_REPO is empty! Config was not parsed correctly.\"
         exit 1
      fi
      
      echo \"==================================================\"
      echo \"   OpenWrt SOURCE Builder for $$PROFILE_NAME\"
      echo \"==================================================\"
      
      START_TIME=$$(date +%s)
      TIMESTAMP=$$(TZ='UTC-3' date +%d%m%y-%H%M%S)
      
      # === 1. GIT SETUP ===
      if [ ! -d \".git\" ]; then
          echo \"[GIT] Initializing repo in non-empty dir...\"
          # Убираем надоедливое предупреждение о ветке master/main
          git config --global init.defaultBranch master
          git init
          git remote add origin \"$$SRC_REPO\"
      fi
      
      echo \"[GIT] Fetching $$SRC_BRANCH...\"
      git fetch origin \"$$SRC_BRANCH\"
      
      echo \"[GIT] Checkout/Reset to $$SRC_BRANCH...\"      
      git config --global advice.detachedHead false
      git checkout -f \"FETCH_HEAD\"
      git reset --hard \"FETCH_HEAD\"

      # === SWITCH TO GITHUB MIRRORS ===      
      if [ -f feeds.conf.default ]; then
          echo \"[FIX] Switching feeds to GitHub mirrors...\"
          sed -i 's|https://git.openwrt.org/feed/|https://github.com/openwrt/|g' feeds.conf.default
          sed -i 's|https://git.openwrt.org/project/|https://github.com/openwrt/|g' feeds.conf.default
      fi

      # === 2. FEEDS ===
      echo \"[FEEDS] Updating and Installing feeds...\"
      ./scripts/feeds update -a
      ./scripts/feeds install -a

      # === BUILD HOOKS (PRE-BUILD SCRIPT) ===
      TARGET_MK=\"include/kernel-defaults.mk\"
      BACKUP_MK=\"include/kernel-defaults.mk.bak\"
      VERMAGIC_MARKER=\".last_vermagic\"
      
      echo \"[HOOKS] Checking for custom hooks in /overlay_files/hooks.sh...\"

      if [ -f \"/overlay_files/hooks.sh\" ]; then
          echo \"[HOOKS] Found hooks.sh! Sanitizing (CRLF -> LF) and executing...\"

          tr -d '\\r' < \"/overlay_files/hooks.sh\" > /tmp/hooks.sh
          chmod +x /tmp/hooks.sh
          /bin/bash /tmp/hooks.sh || {
              echo \"[ERROR] hooks.sh failed!\"
              exit 1
          }

          echo \"[HOOKS] Custom modifications applied successfully.\"
      else
          echo \"[HOOKS] hooks.sh not found. Checking system state...\"
          echo \"\"
          echo \"[DEBUG] ========== STATE CHECK BEGIN ==========\"
          echo \"[DEBUG] TARGET_MK = $$TARGET_MK\"
          echo \"[DEBUG] BACKUP_MK = $$BACKUP_MK\"
          echo \"[DEBUG] VERMAGIC_MARKER = $$VERMAGIC_MARKER\"
          echo \"\"

          # Проверяем, нужны ли какие-то действия
          NEEDS_ROLLBACK=false
          
          # Проверка 1: Makefile патчен?
          echo \"[DEBUG] Check 1: Is Makefile patched?\"
          if [ -f \"$$TARGET_MK\" ]; then
              echo \"[DEBUG]   - File exists: YES\"
              if grep -Fq '$(MKHASH) md5' \"$$TARGET_MK\" 2>/dev/null; then
                  echo \"[DEBUG]   - Contains original string: YES (clean)\"
              else
                  echo \"[DEBUG]   - Contains original string: NO (patched!)\"
                  NEEDS_ROLLBACK=true
              fi
          else
              echo \"[DEBUG]   - File exists: NO\"
          fi
          
          # Проверка 2: Маркер существует?
          echo \"[DEBUG] Check 2: Does vermagic marker exist?\"
          if [ -f \"$$VERMAGIC_MARKER\" ]; then
              MARKER_CONTENT=\$$(cat \"$$VERMAGIC_MARKER\")
              echo \"[DEBUG]   - Marker exists: YES (content: $$MARKER_CONTENT)\"
              NEEDS_ROLLBACK=true
          else
              echo \"[DEBUG]   - Marker exists: NO\"
          fi
          
          # Проверка 3: Бэкап существует?
          echo \"[DEBUG] Check 3: Does backup exist?\"
          if [ -f \"$$BACKUP_MK\" ]; then
              echo \"[DEBUG]   - Backup exists: YES\"
              ls -lh \"$$BACKUP_MK\"
              NEEDS_ROLLBACK=true
          else
              echo \"[DEBUG]   - Backup exists: NO\"
          fi
          
          echo \"[DEBUG] NEEDS_ROLLBACK = $$NEEDS_ROLLBACK\"
          echo \"[DEBUG] ========== STATE CHECK END ==========\"
          echo \"\"

          if [ \"$$NEEDS_ROLLBACK\" = \"false\" ]; then
              echo \"[HOOKS] ✓ System already in clean state. Nothing to do.\"
          else
              echo \"[HOOKS] Dirty state detected. Performing rollback and cache cleanup...\"
              echo \"\"

              # 1. Восстановление оригинального Makefile из бэкапа
              if [ -f \"$$BACKUP_MK\" ]; then
                  echo \"[DEBUG] Backup file found, processing restoration...\"
                  
                  if ! grep -Fq '$(MKHASH) md5' \"$$TARGET_MK\" 2>/dev/null; then
                      echo \"[HOOKS] Restoring $$TARGET_MK from backup...\"
                      echo \"[DEBUG] Before restore:\"
                      grep -n 'MKHASH' \"$$TARGET_MK\" | head -5
                      
                      cp -f \"$$BACKUP_MK\" \"$$TARGET_MK\"
                      
                      echo \"[DEBUG] After restore:\"
                      grep -n 'MKHASH' \"$$TARGET_MK\" | head -5
                      
                      # Проверка восстановления
                      if grep -Fq '$(MKHASH) md5' \"$$TARGET_MK\"; then
                          echo -e \"\\033[0;32m[HOOKS] ✓ Makefile restored: vermagic will be computed dynamically\\033[0m\"
                          echo \"[HOOKS] Original line restored: \\\$(MKHASH) md5 ...\"
                      else
                          echo -e \"\\033[0;31m[HOOKS] ✗ Failed to restore Makefile!\\033[0m\"
                          exit 1
                      fi
                  else
                      echo \"[HOOKS] ✓ Makefile already in original state\"
                  fi
                  
                  # Удаляем бэкап после восстановления
                  echo \"[DEBUG] Attempting to remove backup: $$BACKUP_MK\"
                  rm -f \"$$BACKUP_MK\"
                  
                  # Проверка удаления
                  if [ -f \"$$BACKUP_MK\" ]; then
                      echo \"[DEBUG] ✗ FAILED to remove backup!\"
                      ls -lh \"$$BACKUP_MK\"
                  else
                      echo \"[HOOKS] ✓ Backup file removed\"
                      echo \"[DEBUG] ✓ Backup successfully deleted\"
                  fi
              elif [ -f \"$$TARGET_MK\" ]; then
                  echo \"[DEBUG] No backup found, attempting git restore...\"
                  git checkout -- \"$$TARGET_MK\" 2>/dev/null || true
                  
                  if grep -Fq '$(MKHASH) md5' \"$$TARGET_MK\"; then
                      echo -e \"\\033[0;32m[HOOKS] ✓ Git restore successful: using dynamic vermagic\\033[0m\"
                  fi
              fi

              # 2. Удаление маркера vermagic
              if [ -f \"$$VERMAGIC_MARKER\" ]; then
                  OLD_HASH=\$$(cat \"$$VERMAGIC_MARKER\")
                  echo \"[HOOKS] Removing vermagic marker (was: $$OLD_HASH)...\"
                  rm -f \"$$VERMAGIC_MARKER\"
                  
                  if [ -f \"$$VERMAGIC_MARKER\" ]; then
                      echo \"[DEBUG] ✗ FAILED to remove marker!\"
                  else
                      echo -e \"\\033[0;33m[HOOKS] ✓ Marker removed: next build will compute fresh hash\\033[0m\"
                  fi
              fi

              # 3. Очистка кэша ядра (аналогично hooks.sh)
              echo \"[HOOKS] Cleaning kernel cache...\"
              make target/linux/clean > /dev/null 2>&1 || true
              find build_dir/target-* -maxdepth 1 -type d -name \"linux-*\" -exec rm -rf {} + 2>/dev/null || true
              echo \"[HOOKS] ✓ Kernel cache cleaned\"

              # 4. Сброс CCACHE
              if [ -d \"/ccache\" ]; then
                  echo \"[HOOKS] Resetting build ccache...\"
                  rm -rf /ccache/*
                  echo \"[HOOKS] ✓ CCACHE reset\"
              fi

              echo \"\"
              echo \"============================================================\"
              echo \"=== ROLLBACK COMPLETE ===\"
              echo \"=== System restored to original OpenWrt build state\"
              echo \"=== Vermagic will be computed dynamically from sources\"
              echo \"============================================================\"
              echo \"\"
          fi
      fi

      # === CUSTOM SOURCES ===
      # ВАЖНО: Сюда нужно класть ПАПКИ с исходниками (Makefile), а не .ipk файлы!
      if [ -d \"/input_packages\" ] && [ \"$$(ls -A /input_packages)\" ]; then
          echo \"[PKG] Injecting custom sources into package/ directory...\"
          cp -rf /input_packages/* package/
      fi

      # === 3. CONFIGURATION ===
      echo \"[CONFIG] Generating .config...\"
      rm -f .config      
      echo \"CONFIG_CCACHE=y\" >> .config
      
      # Базовая конфигурация Target
      echo \"CONFIG_TARGET_$$SRC_TARGET=y\" >> .config
      echo \"CONFIG_TARGET_$${SRC_TARGET}_$${SRC_SUBTARGET}=y\" >> .config
      echo \"CONFIG_TARGET_$${SRC_TARGET}_$${SRC_SUBTARGET}_DEVICE_$$TARGET_PROFILE=y\" >> .config
      
      # Добавляем пользовательские пакеты из SRC_PACKAGES
      for pkg in $$SRC_PACKAGES; do
          if [[ \"$$pkg\" == -* ]]; then
              clean_pkg=\"$${pkg#-}\"
              echo \"# CONFIG_PACKAGE_$$clean_pkg is not set\" >> .config
          else
              echo \"CONFIG_PACKAGE_$$pkg=y\" >> .config
          fi
      done
      
      # Apply LUCI default (если пользователь не указал его сам)      
      if ! grep -q \"CONFIG_PACKAGE_luci=y\" .config; then
          echo \"CONFIG_PACKAGE_luci=y\" >> .config
      fi
      
      # Sizes
      if [ -n \"$$ROOTFS_SIZE\" ]; then
        echo \"CONFIG_TARGET_ROOTFS_PARTSIZE=$$ROOTFS_SIZE\" >> .config
      fi

      if [ -n \"$$KERNEL_SIZE\" ]; then
        echo \"CONFIG_TARGET_KERNEL_PARTSIZE=$$KERNEL_SIZE\" >> .config
      fi

      # === EXTRA CONFIG (Disable devices / Low level options) ===
      if [ -n \"$$SRC_EXTRA_CONFIG\" ]; then
          echo \"[CONFIG] Applying extra config options (SRC_EXTRA_CONFIG)...\"
          # Обрабатываем переменную как список строк
          for opt in $$SRC_EXTRA_CONFIG; do
              echo \"$$opt\" >> .config
          done
      fi

      echo \"[DEBUG] Showing generated SEED .config:\"
      echo \"----------------------------------------\"
      cat .config
      echo \"----------------------------------------\"
      make defconfig
      
      # === 4. CUSTOM FILES ===
      if [ -d \"/overlay_files\" ] && [ \"$$(ls -A /overlay_files)\" ]; then
          echo \"[FILES] Copying overlay files...\"
          mkdir -p files
          cp -r /overlay_files/* files/
          rm -f files/hooks.sh
      fi
      
      # === 5. DOWNLOAD ===
      echo \"[DOWNLOAD] Downloading sources to cache...\"
      mkdir -p dl      
      make download || (echo \"[ERROR] Download failed! Retrying with logging...\" && make download V=s && exit 1)
      
      # === 6. BUILD ===
      echo \"[BUILD] Starting compilation (Jobs: $$(nproc))...\"      
      make -j$$(nproc) || (echo \"[ERROR] Multicore build failed. Retrying single core V=s...\" && make -j1 V=s)
      
      # === 7. ARTIFACTS ===
      echo \"[SAVE] Saving artifacts...\"
      TARGET_DIR=\"/output/$$TIMESTAMP\"
      mkdir -p \"$$TARGET_DIR\"
      
      # Ищем файлы в bin/targets
      find bin/targets/$$SRC_TARGET/$$SRC_SUBTARGET -type f -not -path \"*/packages/*\" -exec cp {} \"$$TARGET_DIR/\" \\;
      
      # Сохраняем итоговый конфиг для справки
      cp .config \"$$TARGET_DIR/build.config\"
      
      END_TIME=$$(date +%s)
      ELAPSED=$$((END_TIME - START_TIME))
      
      echo \"\"
      echo \"============================================================\"
      echo \"=== Сборка $$PROFILE_NAME завершена за $${ELAPSED}с.\"
      echo \"=== Образы: firmware_output/sourcebuilder/$$PROFILE_ID/$$TIMESTAMP\"
      echo \"============================================================\"
      EOF
      
      chmod +x /tmp/build_script.sh
      chown build:build /tmp/build_script.sh
      
      echo '[EXEC] Switching to user build...'
      sudo -E -u build bash /tmp/build_script.sh
      "

  builder-src-oldwrt:
    build:
      context: .
      dockerfile: src.dockerfile.legacy
    user: "root"
    environment:
      - CONF_FILE=${SELECTED_CONF}
    volumes:
      - src-workdir:/home/build/openwrt
      - src-dl-cache:/home/build/openwrt/dl
      - src-ccache:/ccache
      - ./profiles:/profiles
      - ./src_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./openssl.cnf:/openssl.cnf
    command: *src_build_script

volumes:
  src-dl-cache:
  src-workdir:
  src-ccache:
