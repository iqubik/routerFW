# file: srcBuilder\docker-compose-src.yaml v1.6
services:
  builder-src-openwrt:
    build:
      context: .
      dockerfile: src.dockerfile
    user: "root"
    environment:
      - CONF_FILE=${SELECTED_CONF}
      - CCACHE_DIR=/ccache
    volumes:
      - src-workdir:/home/build/openwrt
      - src-dl-cache:/home/build/openwrt/dl
      - src-ccache:/ccache
      - ./profiles:/profiles
      - ./src_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./openssl.cnf:/openssl.cnf

    command: &src_build_script |
      /bin/bash -c "
      set -e
      echo '[INIT] Checking volume permissions...'
      
      # 1. Исправление прав для рабочей папки
      if [ \"$$(stat -c '%U' /home/build/openwrt)\" != \"build\" ]; then
          echo \"[INIT] First run detected: Fixing ownership of workdir...\"
          chown -R build:build /home/build/openwrt
      fi

      # 2. FIX: Исправление прав для CCACHE (Иначе компилятор не сможет писать кэш и упадет)
      if [ -d \"/ccache\" ] && [ \"$$(stat -c '%U' /ccache)\" != \"build\" ]; then
          echo \"[INIT] Fixing ownership of /ccache volume...\"
          chown -R build:build /ccache
      fi

      # Создаем скрипт сборки внутри контейнера
      cat << 'EOF' > /tmp/build_script.sh      
      set -e
      export HOME=/home/build
      PROFILE_ID=$$(basename \"$$CONF_FILE\" .conf)

      # === 0. Setup Environment ===
      if [ ! -f \"/profiles/$$CONF_FILE\" ]; then
        echo \"FATAL: Profile /profiles/$$CONF_FILE not found!\"
        exit 1
      fi
      
      # === КОНВЕРТАЦИЯ CRLF -> LF И УДАЛЕНИЕ BOM ===
      echo \"[INIT] Normalizing config...\"
      cat \"/profiles/$$CONF_FILE\" | sed '1s/^\\xEF\\xBB\\xBF//' | tr -d '\\r' > /tmp/clean_config.env
      source /tmp/clean_config.env

      # ВАЖНО: Экспортируем переменные, чтобы hooks.sh их видел
      export SRC_REPO SRC_BRANCH SRC_TARGET SRC_SUBTARGET SRC_DEVICE PROFILE_NAME SRC_PACKAGES

      if [ -z \"$$SRC_REPO\" ]; then
         echo \"[ERROR] SRC_REPO is empty! Config was not parsed correctly.\"
         exit 1
      fi
      
      echo \"==================================================\"
      echo \"   OpenWrt SOURCE Builder for $$PROFILE_NAME\"
      echo \"==================================================\"
      
      START_TIME=$$(date +%s)
      TIMESTAMP=$$(TZ='UTC-3' date +%d%m%y-%H%M%S)
      
      # === 1. GIT SETUP ===
      if [ ! -d \".git\" ]; then
          echo \"[GIT] Initializing repo in non-empty dir...\"
          # Убираем надоедливое предупреждение о ветке master/main
          git config --global init.defaultBranch master
          git init
          git remote add origin \"$$SRC_REPO\"
      fi
      
      echo \"[GIT] Fetching $$SRC_BRANCH...\"
      git fetch origin \"$$SRC_BRANCH\"
      
      echo \"[GIT] Checkout/Reset to $$SRC_BRANCH...\"      
      git config --global advice.detachedHead false
      git checkout -f \"FETCH_HEAD\"
      git reset --hard \"FETCH_HEAD\"

      # === SWITCH TO GITHUB MIRRORS ===      
      if [ -f feeds.conf.default ]; then
          echo \"[FIX] Switching feeds to GitHub mirrors...\"
          sed -i 's|https://git.openwrt.org/feed/|https://github.com/openwrt/|g' feeds.conf.default
          sed -i 's|https://git.openwrt.org/project/|https://github.com/openwrt/|g' feeds.conf.default
      fi

      # === 2. FEEDS ===
      echo \"[FEEDS] Updating and Installing feeds...\"
      ./scripts/feeds update -a
      ./scripts/feeds install -a

      # === BUILD HOOKS (PRE-BUILD SCRIPT) ===
      # Если в папке профиля есть hooks.sh, выполняем его
      if [ -f \"/overlay_files/hooks.sh\" ]; then
          echo \"[HOOKS] Found hooks.sh! Sanitizing (CRLF -> LF) and executing...\"
          
          # 1. Читаем файл, удаляем Windows-спецсимволы (\r) и сохраняем чистую копию в /tmp
          # Это делает скрипт устойчивым к редактированию в Notepad/VSCode под Windows
          tr -d '\\r' < \"/overlay_files/hooks.sh\" > /tmp/hooks.sh
          
          # 2. Делаем исполняемым
          chmod +x /tmp/hooks.sh
          
          # 3. Запускаем
          /bin/bash /tmp/hooks.sh
          
          # Проверяем статус
          if [ $$? -ne 0 ]; then
              echo \"[ERROR] hooks.sh failed!\"
              exit 1
          fi
          echo \"[HOOKS] Custom modifications applied successfully.\"
      fi

      # === CUSTOM SOURCES ===
      # ВАЖНО: Сюда нужно класть ПАПКИ с исходниками (Makefile), а не .ipk файлы!
      if [ -d \"/input_packages\" ] && [ \"$$(ls -A /input_packages)\" ]; then
          echo \"[PKG] Injecting custom sources into package/ directory...\"
          cp -rf /input_packages/* package/
      fi

      # === 3. CONFIGURATION ===
      echo \"[CONFIG] Generating .config...\"
      rm -f .config      
      echo \"CONFIG_CCACHE=y\" >> .config
      
      # Базовая конфигурация Target
      echo \"CONFIG_TARGET_$$SRC_TARGET=y\" >> .config
      echo \"CONFIG_TARGET_$${SRC_TARGET}_$${SRC_SUBTARGET}=y\" >> .config
      echo \"CONFIG_TARGET_$${SRC_TARGET}_$${SRC_SUBTARGET}_DEVICE_$$TARGET_PROFILE=y\" >> .config
      
      # Добавляем пользовательские пакеты из SRC_PACKAGES
      for pkg in $$SRC_PACKAGES; do
          if [[ \"$$pkg\" == -* ]]; then
              clean_pkg=\"$${pkg#-}\"
              echo \"# CONFIG_PACKAGE_$$clean_pkg is not set\" >> .config
          else
              echo \"CONFIG_PACKAGE_$$pkg=y\" >> .config
          fi
      done
      
      # Apply LUCI default (если пользователь не указал его сам)      
      if ! grep -q \"CONFIG_PACKAGE_luci=y\" .config; then
          echo \"CONFIG_PACKAGE_luci=y\" >> .config
      fi
      
      # Sizes
      if [ -n \"$$ROOTFS_SIZE\" ]; then
        echo \"CONFIG_TARGET_ROOTFS_PARTSIZE=$$ROOTFS_SIZE\" >> .config
      fi

      if [ -n \"$$KERNEL_SIZE\" ]; then
        echo \"CONFIG_TARGET_KERNEL_PARTSIZE=$$KERNEL_SIZE\" >> .config
      fi

      # === EXTRA CONFIG (Disable devices / Low level options) ===
      if [ -n \"$$SRC_EXTRA_CONFIG\" ]; then
          echo \"[CONFIG] Applying extra config options (SRC_EXTRA_CONFIG)...\"
          # Обрабатываем переменную как список строк
          for opt in $$SRC_EXTRA_CONFIG; do
              echo \"$$opt\" >> .config
          done
      fi

      echo \"[DEBUG] Showing generated SEED .config:\"
      echo \"----------------------------------------\"
      cat .config
      echo \"----------------------------------------\"
      make defconfig
      
      # === 4. CUSTOM FILES ===
      if [ -d \"/overlay_files\" ] && [ \"$$(ls -A /overlay_files)\" ]; then
          echo \"[FILES] Copying overlay files...\"
          mkdir -p files
          cp -r /overlay_files/* files/
          rm -f files/hooks.sh
      fi
      
      # === 5. DOWNLOAD ===
      echo \"[DOWNLOAD] Downloading sources to cache...\"
      mkdir -p dl      
      make download || (echo \"[ERROR] Download failed! Retrying with logging...\" && make download V=s && exit 1)
      
      # === 6. BUILD ===
      echo \"[BUILD] Starting compilation (Jobs: $$(nproc))...\"      
      make -j$$(nproc) || (echo \"[ERROR] Multicore build failed. Retrying single core V=s...\" && make -j1 V=s)
      
      # === 7. ARTIFACTS ===
      echo \"[SAVE] Saving artifacts...\"
      TARGET_DIR=\"/output/$$TIMESTAMP\"
      mkdir -p \"$$TARGET_DIR\"
      
      # Ищем файлы в bin/targets
      find bin/targets/$$SRC_TARGET/$$SRC_SUBTARGET -type f -not -path \"*/packages/*\" -exec cp {} \"$$TARGET_DIR/\" \\;
      
      # Сохраняем итоговый конфиг для справки
      cp .config \"$$TARGET_DIR/build.config\"
      
      END_TIME=$$(date +%s)
      ELAPSED=$$((END_TIME - START_TIME))
      
      echo \"\"
      echo \"============================================================\"
      echo \"=== Сборка $$PROFILE_NAME завершена за $${ELAPSED}с.\"
      echo \"=== Образы: firmware_output/sourcebuilder/$$PROFILE_ID/$$TIMESTAMP\"
      echo \"============================================================\"
      EOF
      
      chmod +x /tmp/build_script.sh
      chown build:build /tmp/build_script.sh
      
      echo '[EXEC] Switching to user build...'
      sudo -E -u build bash /tmp/build_script.sh
      "

  builder-src-oldwrt:
    build:
      context: .
      dockerfile: src.dockerfile.legacy
    user: "root"
    environment:
      - CONF_FILE=${SELECTED_CONF}
    volumes:
      - src-workdir:/home/build/openwrt
      - src-dl-cache:/home/build/openwrt/dl
      - src-ccache:/ccache
      - ./profiles:/profiles
      - ./src_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./openssl.cnf:/openssl.cnf
    command: *src_build_script

volumes:
  src-dl-cache:
  src-workdir:
  src-ccache:
