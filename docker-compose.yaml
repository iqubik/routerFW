# file: docker-compose.yaml V1.0
services:
  # === MODERN BUILDER (Ubuntu 22.04) ===
  builder-beeline:
    build: .
    environment:
      - CONF_FILE=${SELECTED_CONF}
    volumes:
      # 1. КЭШ АРХИВОВ
      - imagebuilder-cache:/cache
      # 2. КЭШ ПАКЕТОВ
      - ipk-cache:/builder_workspace/dl
      # 3. РЕПОЗИТОРИЙ ПАКЕТОВ
      - ./custom_packages:/input_packages
      # 4. ДИНАМИЧЕСКИЕ ПУТИ
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      # 5. КОНФИГУРАЦИЯ
      - ./profiles:/profiles
      # 6. Фикс SSL (если нужен)
      - ./openssl.cnf:/openssl.cnf
    command: &build_script |
      /bin/bash -c "
      set -e  # Прерывать при ошибках
      
      # Проверка профиля
      if [ ! -f \"/profiles/$$CONF_FILE\" ]; then
        echo \"FATAL: Profile /profiles/$$CONF_FILE not found!\"
        exit 1
      fi
      
      # === [FIX] КОНВЕРТАЦИЯ CRLF -> LF ===
      echo \"[INIT] Normalizing config line endings...\"
      tr -d '\\r' < \"/profiles/$$CONF_FILE\" > /tmp/clean_config.env

      # Подгружаем настройки
      source /tmp/clean_config.env
      
      # ЗАСЕКАЕМ ВРЕМЯ
      START_TIME=$$(date +%s)
      # Формат времени для папки (можно поменять на YYYY-MM-DD для сортировки)
      TIMESTAMP=$$(TZ='UTC-3' date +%d%m%y-%H%M%S)

      # --- 1. КЭШИРОВАНИЕ IMAGEBUILDER ---
      ARCHIVE_NAME=$$(basename \"$$IMAGEBUILDER_URL\")
      CACHE_FILE=\"/cache/$$ARCHIVE_NAME\"

      if [ ! -f \"$$CACHE_FILE\" ]; then
        echo \"[CACHE MISS] Downloading $$ARCHIVE_NAME...\"        
        wget -q \"$$IMAGEBUILDER_URL\" -O \"$$CACHE_FILE\"
      else
        echo \"[CACHE HIT] Using $$ARCHIVE_NAME\"
      fi
      
      echo \"Extracting...\"
      if echo \"$$IMAGEBUILDER_URL\" | grep -q '.zst$$'; then
          tar -I zstd -xf \"$$CACHE_FILE\" --strip-components=1
      else
          tar -xJf \"$$CACHE_FILE\" --strip-components=1
      fi

      # --- 2. ФИКСЫ (ВОССТАНОВЛЕН ПРАВИЛЬНЫЙ ПУТЬ) ---
      if [ -f /openssl.cnf ]; then
         echo \"Applying OpenSSL Fix to /builder/shared-workdir/...\"
         # Создаем путь-обманку, который зашит в бинарниках OpenWrt
         mkdir -p /builder/shared-workdir/build/staging_dir/host/etc/ssl
         cp /openssl.cnf /builder/shared-workdir/build/staging_dir/host/etc/ssl/openssl.cnf
      fi
      
      # Копируем кастомные IPK
      [ -d /input_packages ] && cp /input_packages/*.ipk packages/ 2>/dev/null || true

      export SOURCE_DATE_EPOCH=$$(date +%s)

      # === ИЗМЕНЕНИЕ РАЗМЕРА РАЗДЕЛОВ ===

      # RootFS
      if [ -n \"$$ROOTFS_SIZE\" ]; then
        echo \"[CONFIG] Setting RootFS size to $$ROOTFS_SIZE MB...\"
        # Создаем файл, если его нет, чтобы sed не ругался
        touch .config
        # Удаляем старое значение, чтобы не дублировалось
        sed -i '/CONFIG_TARGET_ROOTFS_PARTSIZE/d' .config
        # Добавляем нужное значение
        echo \"CONFIG_TARGET_ROOTFS_PARTSIZE=$$ROOTFS_SIZE\" >> .config
      else
        echo \"[CONFIG] Using default RootFS size\"
      fi

      # Kernel Size
      if [ -n \"$$KERNEL_SIZE\" ]; then
        echo \"[CONFIG] Setting Kernel size to $$KERNEL_SIZE MB...\"
        touch .config
        sed -i '/CONFIG_TARGET_KERNEL_PARTSIZE/d' .config
        echo \"CONFIG_TARGET_KERNEL_PARTSIZE=$$KERNEL_SIZE\" >> .config
      else
        echo \"[CONFIG] Using default KernelFS size\"
      fi

      # === ДОБАВЛЕНИЕ РЕПОЗИТОРИЕВ ===
      if [ -n \"$$EXTRA_REPO_URL\" ]; then
         echo \"[REPO] Adding custom repo...\"
         echo \"src/gz custom_repo $$EXTRA_REPO_URL\" >> repositories.conf
      else
        echo \"[CONFIG] No EXTRA_REPO_URL conf found in profile.\"         
      fi

      # --- 3. СБОРКА ---
      echo \"Starting make image for $$TARGET_PROFILE...\"      
      MAKE_ARGS=\"PROFILE=\\\"$$TARGET_PROFILE\\\" FILES=\\\"/overlay_files\\\" PACKAGES=\\\"$$PKGS\\\"\"      
      if [ -n \"$$EXTRA_IMAGE_NAME\" ]; then
          MAKE_ARGS=\"$$MAKE_ARGS EXTRA_IMAGE_NAME=\\\"$$EXTRA_IMAGE_NAME\\\"\"
      fi      
      if [ -n \"$$DISABLED_SERVICES\" ]; then
          MAKE_ARGS=\"$$MAKE_ARGS DISABLED_SERVICES=\\\"$$DISABLED_SERVICES\\\"\"
      fi
      
      echo \"Running: make image $$MAKE_ARGS\"      
      eval make image $$MAKE_ARGS      
      
      # --- 4. СОХРАНЕНИЕ (ИЗМЕНЕНО) ---
      echo \"Saving artifacts...\" 
      
      # Формируем путь к целевой папке: /output/DATE-TIME
      TARGET_DIR=\"/output/$$TIMESTAMP\"
      mkdir -p \"$$TARGET_DIR\"
      
      # Ищем файлы и копируем их ВНУТРЬ папки
      find bin/targets -type f -not -path \"*/packages/*\" | while read f; do
          cp \"$$f\" \"$$TARGET_DIR/\"
      done

      # --- 5. РАСЧЕТ ВРЕМЕНИ ---
      END_TIME=$$(date +%s)
      ELAPSED=$$((END_TIME - START_TIME))
      
      echo \"\"
      echo \"============================================================\"
      echo \"=== Сборка $$PROFILE_NAME завершена за $${ELAPSED}с.\"
      echo \"=== Файлы сохранены в: firmware_output/$$PROFILE_NAME/$$TIMESTAMP\"
      echo \"============================================================\"
      "

  # === LEGACY BUILDER (Ubuntu 18.04) ===
  builder-841n:
    build:
      context: .
      dockerfile: dockerfile.841n
    environment:
      - CONF_FILE=${SELECTED_CONF}
    volumes:
      - imagebuilder-cache:/cache
      - ipk-cache:/builder_workspace/dl
      - ./custom_packages:/input_packages
      - ${HOST_FILES_DIR}:/overlay_files
      - ${HOST_OUTPUT_DIR}:/output
      - ./profiles:/profiles
    command: *build_script

volumes:
  imagebuilder-cache:
  ipk-cache: